<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>KVM 简介 | FreeFlyingSheep 的小站</title><meta name=keywords content="KVM,Linux 内核"><meta name=description content="简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。"><meta name=author content="FreeFlyingSheep"><link rel=canonical href=https://freeflyingsheep.github.io/posts/virtualization/kvm/><link crossorigin=anonymous href=/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as=style><link rel=preload href=/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://freeflyingsheep.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://freeflyingsheep.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://freeflyingsheep.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://freeflyingsheep.github.io/apple-touch-icon.png><link rel=mask-icon href=https://freeflyingsheep.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><meta property="og:title" content="KVM 简介"><meta property="og:description" content="简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。"><meta property="og:type" content="article"><meta property="og:url" content="https://freeflyingsheep.github.io/posts/virtualization/kvm/"><meta property="og:image" content="https://freeflyingsheep.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-09T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://freeflyingsheep.github.io/papermod-cover.png"><meta name=twitter:title content="KVM 简介"><meta name=twitter:description content="简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://freeflyingsheep.github.io/posts/"},{"@type":"ListItem","position":2,"name":"KVM 简介","item":"https://freeflyingsheep.github.io/posts/virtualization/kvm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"KVM 简介","name":"KVM 简介","description":"简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。\n","keywords":["KVM","Linux 内核"],"articleBody":"简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。\nKVM (Kernel-based Virtual Machine) KVM 是一个完整的虚拟化解决方案，允许用户在特定机器上用虚拟机直接运行未经修改的 Linux 内核。\nKVM 通常和 QEMU 结合使用，见 QEMU 简介。\nKVM 的 API 接口可以参考内核文档。\nKVM 模块有体系结构相关和无关的两部分，简单起见，体系结构相关的部分只考虑 MIPS 的代码，选用内核源码版本为 5.10.42。\n模块初始化 arch/mips/kvm/mips.c：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  static int __init kvm_mips_init(void) { int ret; if (cpu_has_mmid) { pr_warn(\"KVM does not yet support MMIDs. KVM Disabled\\n\"); return -EOPNOTSUPP; } ret = kvm_mips_entry_setup(); if (ret) return ret; ret = kvm_init(NULL, sizeof(struct kvm_vcpu), 0, THIS_MODULE); if (ret) return ret; if (boot_cpu_type() == CPU_LOONGSON64) kvm_priority_to_irq = kvm_loongson3_priority_to_irq; register_die_notifier(\u0026kvm_mips_csr_die_notifier); return 0; } module_init(kvm_mips_init);   kvm_mips_init() 函数会调用体系结构无关的初始化函数 kvm_init()。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104  int kvm_init(void *opaque, unsigned vcpu_size, unsigned vcpu_align, struct module *module) { struct kvm_cpu_compat_check c; int r; int cpu; r = kvm_arch_init(opaque); if (r) goto out_fail; /* * kvm_arch_init makes sure there's at most one caller * for architectures that support multiple implementations, * like intel and amd on x86. * kvm_arch_init must be called before kvm_irqfd_init to avoid creating * conflicts in case kvm is already setup for another implementation. */ r = kvm_irqfd_init(); if (r) goto out_irqfd; if (!zalloc_cpumask_var(\u0026cpus_hardware_enabled, GFP_KERNEL)) { r = -ENOMEM; goto out_free_0; } r = kvm_arch_hardware_setup(opaque); if (r  0) goto out_free_1; c.ret = \u0026r; c.opaque = opaque; for_each_online_cpu(cpu) { smp_call_function_single(cpu, check_processor_compat, \u0026c, 1); if (r  0) goto out_free_2; } r = cpuhp_setup_state_nocalls(CPUHP_AP_KVM_STARTING, \"kvm/cpu:starting\", kvm_starting_cpu, kvm_dying_cpu); if (r) goto out_free_2; register_reboot_notifier(\u0026kvm_reboot_notifier); /* A kmem cache lets us meet the alignment requirements of fx_save. */ if (!vcpu_align) vcpu_align = __alignof__(struct kvm_vcpu); kvm_vcpu_cache = kmem_cache_create_usercopy(\"kvm_vcpu\", vcpu_size, vcpu_align, SLAB_ACCOUNT, offsetof(struct kvm_vcpu, arch), sizeof_field(struct kvm_vcpu, arch), NULL); if (!kvm_vcpu_cache) { r = -ENOMEM; goto out_free_3; } r = kvm_async_pf_init(); if (r) goto out_free; kvm_chardev_ops.owner = module; kvm_vm_fops.owner = module; kvm_vcpu_fops.owner = module; r = misc_register(\u0026kvm_dev); if (r) { pr_err(\"kvm: misc device register failed\\n\"); goto out_unreg; } register_syscore_ops(\u0026kvm_syscore_ops); kvm_preempt_ops.sched_in = kvm_sched_in; kvm_preempt_ops.sched_out = kvm_sched_out; kvm_init_debug(); r = kvm_vfio_ops_init(); WARN_ON(r); return 0; out_unreg: kvm_async_pf_deinit(); out_free: kmem_cache_destroy(kvm_vcpu_cache); out_free_3: unregister_reboot_notifier(\u0026kvm_reboot_notifier); cpuhp_remove_state_nocalls(CPUHP_AP_KVM_STARTING); out_free_2: kvm_arch_hardware_unsetup(); out_free_1: free_cpumask_var(cpus_hardware_enabled); out_free_0: kvm_irqfd_exit(); out_irqfd: kvm_arch_exit(); out_fail: return r; } EXPORT_SYMBOL_GPL(kvm_init);   可以看到，kvm_init() 会调用 misc_register() 函数来注册块设备 /dev/kvm。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  static long kvm_dev_ioctl(struct file *filp, unsigned int ioctl, unsigned long arg) { long r = -EINVAL; switch (ioctl) { case KVM_GET_API_VERSION: if (arg) goto out; r = KVM_API_VERSION; break; case KVM_CREATE_VM: r = kvm_dev_ioctl_create_vm(arg); break; case KVM_CHECK_EXTENSION: r = kvm_vm_ioctl_check_extension_generic(NULL, arg); break; case KVM_GET_VCPU_MMAP_SIZE: if (arg) goto out; r = PAGE_SIZE; /* struct kvm_run */ #ifdef CONFIG_X86  r += PAGE_SIZE; /* pio data page */ #endif #ifdef CONFIG_KVM_MMIO  r += PAGE_SIZE; /* coalesced mmio ring page */ #endif  break; case KVM_TRACE_ENABLE: case KVM_TRACE_PAUSE: case KVM_TRACE_DISABLE: r = -EOPNOTSUPP; break; default: return kvm_arch_dev_ioctl(filp, ioctl, arg); } out: return r; } static struct file_operations kvm_chardev_ops = { .unlocked_ioctl = kvm_dev_ioctl, .llseek = noop_llseek, KVM_COMPAT(kvm_dev_ioctl), }; static struct miscdevice kvm_dev = { KVM_MINOR, \"kvm\", \u0026kvm_chardev_ops, };   创建虚拟机 TODO\n","wordCount":"631","inLanguage":"zh-cn","datePublished":"2021-06-09T00:00:00Z","dateModified":"2021-06-09T00:00:00Z","author":{"@type":"Person","name":"FreeFlyingSheep"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://freeflyingsheep.github.io/posts/virtualization/kvm/"},"publisher":{"@type":"Organization","name":"FreeFlyingSheep 的小站","logo":{"@type":"ImageObject","url":"https://freeflyingsheep.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://freeflyingsheep.github.io/ accesskey=h title="FreeFlyingSheep 的小站 (Alt + H)">FreeFlyingSheep 的小站</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://freeflyingsheep.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://freeflyingsheep.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://freeflyingsheep.github.io/series title=Series><span>Series</span></a></li><li><a href=https://freeflyingsheep.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://freeflyingsheep.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://freeflyingsheep.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://freeflyingsheep.github.io/posts/>Posts</a></div><h1 class=post-title>KVM 简介</h1><div class=post-meta>June 9, 2021&nbsp;·&nbsp;3 min&nbsp;·&nbsp;FreeFlyingSheep</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#kvm-kernel-based-virtual-machine aria-label="KVM (Kernel-based Virtual Machine)">KVM (Kernel-based Virtual Machine)</a></li><li><a href=#%e6%a8%a1%e5%9d%97%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=模块初始化>模块初始化</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba aria-label=创建虚拟机>创建虚拟机</a></li></ul></div></details></div><div class=post-content><p>简单介绍 Linux 内核的 KVM 模块，以 MIPS 体系结构为例，内核源码版本为 5.10.42。</p><h2 id=kvm-kernel-based-virtual-machine>KVM (Kernel-based Virtual Machine)<a hidden class=anchor aria-hidden=true href=#kvm-kernel-based-virtual-machine>#</a></h2><p>KVM 是一个完整的虚拟化解决方案，允许用户在特定机器上用虚拟机直接运行未经修改的 Linux 内核。</p><p>KVM 通常和 QEMU 结合使用，见 <a href=/posts/virtualization/qemu>QEMU 简介</a>。</p><p>KVM 的 API 接口可以参考<a href=https://www.kernel.org/doc/html/latest/virt/kvm/api.html>内核文档</a>。</p><p>KVM 模块有体系结构相关和无关的两部分，简单起见，体系结构相关的部分只考虑 MIPS 的代码，选用内核源码版本为 5.10.42。</p><h2 id=模块初始化>模块初始化<a hidden class=anchor aria-hidden=true href=#模块初始化>#</a></h2><p><code>arch/mips/kvm/mips.c</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>kvm_mips_init</span>(<span style=color:#66d9ef>void</span>)
{
    <span style=color:#66d9ef>int</span> ret;

    <span style=color:#66d9ef>if</span> (cpu_has_mmid) {
        pr_warn(<span style=color:#e6db74>&#34;KVM does not yet support MMIDs. KVM Disabled</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EOPNOTSUPP;
    }

    ret <span style=color:#f92672>=</span> kvm_mips_entry_setup();
    <span style=color:#66d9ef>if</span> (ret)
        <span style=color:#66d9ef>return</span> ret;

    ret <span style=color:#f92672>=</span> kvm_init(NULL, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> kvm_vcpu), <span style=color:#ae81ff>0</span>, THIS_MODULE);

    <span style=color:#66d9ef>if</span> (ret)
        <span style=color:#66d9ef>return</span> ret;

    <span style=color:#66d9ef>if</span> (boot_cpu_type() <span style=color:#f92672>==</span> CPU_LOONGSON64)
        kvm_priority_to_irq <span style=color:#f92672>=</span> kvm_loongson3_priority_to_irq;

    register_die_notifier(<span style=color:#f92672>&amp;</span>kvm_mips_csr_die_notifier);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

module_init(kvm_mips_init);
</code></pre></td></tr></table></div></div><p><code>kvm_mips_init()</code> 函数会调用体系结构无关的初始化函数 <code>kvm_init()</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>kvm_init</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>opaque, <span style=color:#66d9ef>unsigned</span> vcpu_size, <span style=color:#66d9ef>unsigned</span> vcpu_align,
                  <span style=color:#66d9ef>struct</span> module <span style=color:#f92672>*</span>module)
{
    <span style=color:#66d9ef>struct</span> kvm_cpu_compat_check c;
    <span style=color:#66d9ef>int</span> r;
    <span style=color:#66d9ef>int</span> cpu;

    r <span style=color:#f92672>=</span> kvm_arch_init(opaque);
    <span style=color:#66d9ef>if</span> (r)
        <span style=color:#66d9ef>goto</span> out_fail;

    <span style=color:#75715e>/*
</span><span style=color:#75715e>     * kvm_arch_init makes sure there&#39;s at most one caller
</span><span style=color:#75715e>     * for architectures that support multiple implementations,
</span><span style=color:#75715e>     * like intel and amd on x86.
</span><span style=color:#75715e>     * kvm_arch_init must be called before kvm_irqfd_init to avoid creating
</span><span style=color:#75715e>     * conflicts in case kvm is already setup for another implementation.
</span><span style=color:#75715e>     */</span>
    r <span style=color:#f92672>=</span> kvm_irqfd_init();
    <span style=color:#66d9ef>if</span> (r)
        <span style=color:#66d9ef>goto</span> out_irqfd;

    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>zalloc_cpumask_var(<span style=color:#f92672>&amp;</span>cpus_hardware_enabled, GFP_KERNEL)) {
        r <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOMEM;
        <span style=color:#66d9ef>goto</span> out_free_0;
    }

    r <span style=color:#f92672>=</span> kvm_arch_hardware_setup(opaque);
    <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
        <span style=color:#66d9ef>goto</span> out_free_1;

    c.ret <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>r;
    c.opaque <span style=color:#f92672>=</span> opaque;
    for_each_online_cpu(cpu) {
        smp_call_function_single(cpu, check_processor_compat, <span style=color:#f92672>&amp;</span>c, <span style=color:#ae81ff>1</span>);
        <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
            <span style=color:#66d9ef>goto</span> out_free_2;
    }

    r <span style=color:#f92672>=</span> cpuhp_setup_state_nocalls(CPUHP_AP_KVM_STARTING, <span style=color:#e6db74>&#34;kvm/cpu:starting&#34;</span>,
                                  kvm_starting_cpu, kvm_dying_cpu);
    <span style=color:#66d9ef>if</span> (r)
        <span style=color:#66d9ef>goto</span> out_free_2;
    register_reboot_notifier(<span style=color:#f92672>&amp;</span>kvm_reboot_notifier);

    <span style=color:#75715e>/* A kmem cache lets us meet the alignment requirements of fx_save. */</span>
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>vcpu_align)
        vcpu_align <span style=color:#f92672>=</span> __alignof__(<span style=color:#66d9ef>struct</span> kvm_vcpu);
    kvm_vcpu_cache <span style=color:#f92672>=</span>
        kmem_cache_create_usercopy(<span style=color:#e6db74>&#34;kvm_vcpu&#34;</span>, vcpu_size, vcpu_align,
                                   SLAB_ACCOUNT,
                                   offsetof(<span style=color:#66d9ef>struct</span> kvm_vcpu, arch),
                                   sizeof_field(<span style=color:#66d9ef>struct</span> kvm_vcpu, arch),
                                   NULL);
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>kvm_vcpu_cache) {
        r <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOMEM;
        <span style=color:#66d9ef>goto</span> out_free_3;
    }

    r <span style=color:#f92672>=</span> kvm_async_pf_init();
    <span style=color:#66d9ef>if</span> (r)
        <span style=color:#66d9ef>goto</span> out_free;

    kvm_chardev_ops.owner <span style=color:#f92672>=</span> module;
    kvm_vm_fops.owner <span style=color:#f92672>=</span> module;
    kvm_vcpu_fops.owner <span style=color:#f92672>=</span> module;

    r <span style=color:#f92672>=</span> misc_register(<span style=color:#f92672>&amp;</span>kvm_dev);
    <span style=color:#66d9ef>if</span> (r) {
        pr_err(<span style=color:#e6db74>&#34;kvm: misc device register failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
        <span style=color:#66d9ef>goto</span> out_unreg;
    }

    register_syscore_ops(<span style=color:#f92672>&amp;</span>kvm_syscore_ops);

    kvm_preempt_ops.sched_in <span style=color:#f92672>=</span> kvm_sched_in;
    kvm_preempt_ops.sched_out <span style=color:#f92672>=</span> kvm_sched_out;

    kvm_init_debug();

    r <span style=color:#f92672>=</span> kvm_vfio_ops_init();
    WARN_ON(r);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;

out_unreg:
    kvm_async_pf_deinit();
out_free:
    kmem_cache_destroy(kvm_vcpu_cache);
out_free_3:
    unregister_reboot_notifier(<span style=color:#f92672>&amp;</span>kvm_reboot_notifier);
    cpuhp_remove_state_nocalls(CPUHP_AP_KVM_STARTING);
out_free_2:
    kvm_arch_hardware_unsetup();
out_free_1:
    free_cpumask_var(cpus_hardware_enabled);
out_free_0:
    kvm_irqfd_exit();
out_irqfd:
    kvm_arch_exit();
out_fail:
    <span style=color:#66d9ef>return</span> r;
}
EXPORT_SYMBOL_GPL(kvm_init);
</code></pre></td></tr></table></div></div><p>可以看到，<code>kvm_init()</code> 会调用 <code>misc_register()</code> 函数来注册块设备 <code>/dev/kvm</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>kvm_dev_ioctl</span>(<span style=color:#66d9ef>struct</span> file <span style=color:#f92672>*</span>filp,
                          <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ioctl, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> arg)
{
    <span style=color:#66d9ef>long</span> r <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>EINVAL;

    <span style=color:#66d9ef>switch</span> (ioctl) {
    <span style=color:#66d9ef>case</span> KVM_GET_API_VERSION:
        <span style=color:#66d9ef>if</span> (arg)
            <span style=color:#66d9ef>goto</span> out;
        r <span style=color:#f92672>=</span> KVM_API_VERSION;
        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> KVM_CREATE_VM:
        r <span style=color:#f92672>=</span> kvm_dev_ioctl_create_vm(arg);
        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> KVM_CHECK_EXTENSION:
        r <span style=color:#f92672>=</span> kvm_vm_ioctl_check_extension_generic(NULL, arg);
        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> KVM_GET_VCPU_MMAP_SIZE:
        <span style=color:#66d9ef>if</span> (arg)
            <span style=color:#66d9ef>goto</span> out;
        r <span style=color:#f92672>=</span> PAGE_SIZE;     <span style=color:#75715e>/* struct kvm_run */</span>
<span style=color:#75715e>#ifdef CONFIG_X86
</span><span style=color:#75715e></span>        r <span style=color:#f92672>+=</span> PAGE_SIZE;    <span style=color:#75715e>/* pio data page */</span>
<span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_KVM_MMIO
</span><span style=color:#75715e></span>        r <span style=color:#f92672>+=</span> PAGE_SIZE;    <span style=color:#75715e>/* coalesced mmio ring page */</span>
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>case</span> KVM_TRACE_ENABLE:
    <span style=color:#66d9ef>case</span> KVM_TRACE_PAUSE:
    <span style=color:#66d9ef>case</span> KVM_TRACE_DISABLE:
        r <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>EOPNOTSUPP;
        <span style=color:#66d9ef>break</span>;
    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
        <span style=color:#66d9ef>return</span> kvm_arch_dev_ioctl(filp, ioctl, arg);
    }
out:
    <span style=color:#66d9ef>return</span> r;
}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> file_operations kvm_chardev_ops <span style=color:#f92672>=</span> {
    .unlocked_ioctl <span style=color:#f92672>=</span> kvm_dev_ioctl,
    .llseek         <span style=color:#f92672>=</span> noop_llseek,
    KVM_COMPAT(kvm_dev_ioctl),
};

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> miscdevice kvm_dev <span style=color:#f92672>=</span> {
    KVM_MINOR,
    <span style=color:#e6db74>&#34;kvm&#34;</span>,
    <span style=color:#f92672>&amp;</span>kvm_chardev_ops,
};
</code></pre></td></tr></table></div></div><h2 id=创建虚拟机>创建虚拟机<a hidden class=anchor aria-hidden=true href=#创建虚拟机>#</a></h2><p>TODO</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://freeflyingsheep.github.io/tags/kvm/>KVM</a></li><li><a href=https://freeflyingsheep.github.io/tags/linux-%E5%86%85%E6%A0%B8/>Linux 内核</a></li></ul><nav class=paginav><a class=next href=https://freeflyingsheep.github.io/posts/virtualization/qemu/><span class=title>»</span><br><span>QEMU 简介</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://freeflyingsheep.github.io/>FreeFlyingSheep 的小站</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>