<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>内核红黑树 | FreeFlyingSheep 的小站</title><meta name=keywords content="Linux 内核,内核数据结构,红黑树"><meta name=description content="Linux 内核学习笔记系列，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。"><meta name=author content="FreeFlyingSheep"><link rel=canonical href=https://freeflyingsheep.github.io/posts/kernel/data-structure/rbtree/><link crossorigin=anonymous href=/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as=style><link rel=preload href=/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://freeflyingsheep.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://freeflyingsheep.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://freeflyingsheep.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://freeflyingsheep.github.io/apple-touch-icon.png><link rel=mask-icon href=https://freeflyingsheep.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><meta property="og:title" content="内核红黑树"><meta property="og:description" content="Linux 内核学习笔记系列，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。"><meta property="og:type" content="article"><meta property="og:url" content="https://freeflyingsheep.github.io/posts/kernel/data-structure/rbtree/"><meta property="og:image" content="https://freeflyingsheep.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-04T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-04T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://freeflyingsheep.github.io/papermod-cover.png"><meta name=twitter:title content="内核红黑树"><meta name=twitter:description content="Linux 内核学习笔记系列，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://freeflyingsheep.github.io/posts/"},{"@type":"ListItem","position":2,"name":"内核红黑树","item":"https://freeflyingsheep.github.io/posts/kernel/data-structure/rbtree/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"内核红黑树","name":"内核红黑树","description":"Linux 内核学习笔记系列，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。\n","keywords":["Linux 内核","内核数据结构","红黑树"],"articleBody":"Linux 内核学习笔记系列，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。\n红黑树简介 红黑树是一种着色的自平衡的二叉搜索树，Linux 主要的平衡二叉树数据结构就是红黑树。\n红黑树满足以下几个条件：\n 每一个结点或者着成红色，或者着成黑色。 根结点和叶结点是黑色的。 如果一个结点是红色的，那么它的子结点必须是黑色的。 从一个结点到一个叶结点的每一条路径必须包含相同数目的黑色结点。  以上条件保证了红黑树最深的叶结点深度不会大于两倍的最浅叶结点深度（最长路径不会超过最短路径的两倍）。注意，叶结点不存储数据，都是 NULL 指针。\n红黑树的优点是插入、删除、搜索元素都可以在对数时间内完成，缺点是实现复杂。\n显然，红黑树完整的定义和性质的证明，不属于本系列学习笔记的范畴，可以参考数据结构书。\n内核红黑树的使用 内核红黑树的实现称为 rbtree，头文件为 include/linux/rbtree.h。内核红黑树的搜索和插入操作是没有给出完整实现的，一方面是出于 C 语言不方便泛型编程，另一方面是内核开发者相信最有效的搜索和插入方法需要由用户自行实现。用户可以使用提供的辅助函数，但需要自行实现比较操作算子。\n红黑树的创建 创建一个红黑树，需要为其分配一个根结点，并将其初始化为 RB_ROOT：\n1  struct rb_root root = RB_ROOT;   红黑树的搜索 下面是一个搜索的例子，rb_search_page_cache 函数实现了在页高速缓存中搜索一个文件区（由一个 i 结点和一个偏移量共同描述）。每个 i 结点都有自己的 rbtree，以关联在文件中的页偏移。该函数将搜索给定 i 结点的 rbtree，以寻找匹配的偏移值：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  static inline struct page *rb_search_page_cache(struct inode * inode, unsigned long offset) { struct rb_node *n = inode-i_rb_page_cache.rb_node; struct page *page; while (n) { page = rb_entry(n, struct page, rb_page_cache); if (offset  page-offset) n = n-rb_left; else if (offset  page-offset) n = n-rb_right; else return page; } return NULL; }   辅助宏 rb_entry 和内核链表的 list_entry 相似，获取包含结点的数据结构。\n查找特定的（前一个/后一个/第一个/最后一个）结点可以使用如下函数：\n1 2 3 4  struct rb_node *rb_next(const struct rb_node *node); struct rb_node *rb_prev(const struct rb_node *node); struct rb_node *rb_first(const struct rb_root *root); struct rb_node *rb_last(const struct rb_root *root);   红黑树的插入 插入函数需要实现搜索和插入逻辑。还是以上面的情景，对应的插入函数如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  static inline struct page *__rb_insert_page_cache(struct inode *inode, unsigned long offset, struct rb_node *node) { struct rb_node **p = \u0026inode-i_rb_page_cache.rb_node; struct rb_node *parent = NULL; struct page *page; while (*p) { parent = *p; page = rb_entry(parent, struct page, rb_page_cache); if (offset  page-offset) p = \u0026(*p)-rb_left; else if (offset  page-offset) p = \u0026(*p)-rb_right; else return page; } rb_link_node(node, parent, p); return NULL; } static inline struct page *rb_insert_page_cache(struct inode *inode, unsigned long offset, struct rb_node *node) { struct page *ret; if ((ret = __rb_insert_page_cache(inode, offset, node))) goto out; rb_insert_color(node, \u0026inode-i_rb_page_cache); out: return ret; }   辅助函数 rb_link_node() 负责在给定位置插入新结点，rb_insert_color() 负责执行复杂的再平衡操作。\n红黑树的删除 删除结点只需要调用以下函数：\n1  void rb_erase(struct rb_node *node, struct rb_root *root);   替换单个结点 替换单个结点只需要调用以下函数，该函数不会进行再平衡操作：\n1  void rb_replace_node(struct rb_node *victim, struct rb_node *new, struct rb_root *root);   内核红黑树的实现 内核红黑树的实现均位于 lib/rbtree.c 和 include/linux/rbtree.h。本系列学习笔记的重点不在数据结构，下面给出的代码的原理可以参考数据结构书，此处不做详细介绍。个人认为通常情况下，了解红黑树基本概念和如何使用提供的函数就足够了。\n红黑树的定义 1 2 3 4 5 6 7 8 9 10 11 12 13 14  struct rb_node { unsigned long rb_parent_color; #define RB_RED 0 #define RB_BLACK 1  struct rb_node *rb_right; struct rb_node *rb_left; } __attribute__((aligned(sizeof(long)))); /* The alignment might seem pointless, but allegedly CRIS needs it */ struct rb_root { struct rb_node *rb_node; };   其中，rb_parent_color 包含了两部分，一个是指向父结点的指针，另一个是当前结点的颜色，它是 rb_parent_color 的低 2 位。因为在所有体系结构上，指针都是至少 4 字节对齐的，所以这么做是可行的。\n正如注释所吐槽的，对齐到 sizeof(long) 似乎是多余的，或许这也是个历史遗留问题。\n辅助函数/宏的实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  #define rb_parent(r) ((struct rb_node *)((r)-rb_parent_color \u0026 ~3)) #define rb_color(r) ((r)-rb_parent_color \u0026 1) #define rb_is_red(r) (!rb_color(r)) #define rb_is_black(r) rb_color(r) #define rb_set_red(r) do { (r)-rb_parent_color \u0026= ~1; } while (0) #define rb_set_black(r) do { (r)-rb_parent_color |= 1; } while (0)  static inline void rb_set_parent(struct rb_node *rb, struct rb_node *p) { rb-rb_parent_color = (rb-rb_parent_color \u0026 3) | (unsigned long)p; } static inline void rb_set_color(struct rb_node *rb, int color) { rb-rb_parent_color = (rb-rb_parent_color \u0026 ~1) | color; } #define RB_ROOT (struct rb_root) { NULL, } #define rb_entry(ptr, type, member) container_of(ptr, type, member)  #define RB_EMPTY_ROOT(root) ((root)-rb_node == NULL) #define RB_EMPTY_NODE(node) (rb_parent(node) == node) #define RB_CLEAR_NODE(node) (rb_set_parent(node, node))   根据字面意思就可以理解这些辅助函数/宏的用途。\n红黑树的旋转的实现 左旋 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  static void __rb_rotate_left(struct rb_node *node, struct rb_root *root) { struct rb_node *right = node-rb_right; struct rb_node *parent = rb_parent(node); if ((node-rb_right = right-rb_left)) rb_set_parent(right-rb_left, node); right-rb_left = node; rb_set_parent(right, parent); if (parent) { if (node == parent-rb_left) parent-rb_left = right; else parent-rb_right = right; } else root-rb_node = right; rb_set_parent(node, right); }   右旋 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  static void __rb_rotate_right(struct rb_node *node, struct rb_root *root) { struct rb_node *left = node-rb_left; struct rb_node *parent = rb_parent(node); if ((node-rb_left = left-rb_right)) rb_set_parent(left-rb_right, node); left-rb_right = node; rb_set_parent(left, parent); if (parent) { if (node == parent-rb_right) parent-rb_right = left; else parent-rb_left = left; } else root-rb_node = left; rb_set_parent(node, left); }   红黑树的插入的实现 下面给出插入的辅助函数的实现。\n插入结点的实现 1 2 3 4 5 6 7 8  static inline void rb_link_node(struct rb_node * node, struct rb_node * parent, struct rb_node ** rb_link) { node-rb_parent_color = (unsigned long )parent; node-rb_left = node-rb_right = NULL; *rb_link = node; }   再平衡的实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  void rb_insert_color(struct rb_node *node, struct rb_root *root) { struct rb_node *parent, *gparent; while ((parent = rb_parent(node)) \u0026\u0026 rb_is_red(parent)) { gparent = rb_parent(parent); if (parent == gparent-rb_left) { { register struct rb_node *uncle = gparent-rb_right; if (uncle \u0026\u0026 rb_is_red(uncle)) { rb_set_black(uncle); rb_set_black(parent); rb_set_red(gparent); node = gparent; continue; } } if (parent-rb_right == node) { register struct rb_node *tmp; __rb_rotate_left(parent, root); tmp = parent; parent = node; node = tmp; } rb_set_black(parent); rb_set_red(gparent); __rb_rotate_right(gparent, root); } else { { register struct rb_node *uncle = gparent-rb_left; if (uncle \u0026\u0026 rb_is_red(uncle)) { rb_set_black(uncle); rb_set_black(parent); rb_set_red(gparent); node = gparent; continue; } } if (parent-rb_left == node) { register struct rb_node *tmp; __rb_rotate_right(parent, root); tmp = parent; parent = node; node = tmp; } rb_set_black(parent); rb_set_red(gparent); __rb_rotate_left(gparent, root); } } rb_set_black(root-rb_node); } EXPORT_SYMBOL(rb_insert_color);   红黑树的删除的实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147  static void __rb_erase_color(struct rb_node *node, struct rb_node *parent, struct rb_root *root) { struct rb_node *other; while ((!node || rb_is_black(node)) \u0026\u0026 node != root-rb_node) { if (parent-rb_left == node) { other = parent-rb_right; if (rb_is_red(other)) { rb_set_black(other); rb_set_red(parent); __rb_rotate_left(parent, root); other = parent-rb_right; } if ((!other-rb_left || rb_is_black(other-rb_left)) \u0026\u0026 (!other-rb_right || rb_is_black(other-rb_right))) { rb_set_red(other); node = parent; parent = rb_parent(node); } else { if (!other-rb_right || rb_is_black(other-rb_right)) { rb_set_black(other-rb_left); rb_set_red(other); __rb_rotate_right(other, root); other = parent-rb_right; } rb_set_color(other, rb_color(parent)); rb_set_black(parent); rb_set_black(other-rb_right); __rb_rotate_left(parent, root); node = root-rb_node; break; } } else { other = parent-rb_left; if (rb_is_red(other)) { rb_set_black(other); rb_set_red(parent); __rb_rotate_right(parent, root); other = parent-rb_left; } if ((!other-rb_left || rb_is_black(other-rb_left)) \u0026\u0026 (!other-rb_right || rb_is_black(other-rb_right))) { rb_set_red(other); node = parent; parent = rb_parent(node); } else { if (!other-rb_left || rb_is_black(other-rb_left)) { rb_set_black(other-rb_right); rb_set_red(other); __rb_rotate_left(other, root); other = parent-rb_left; } rb_set_color(other, rb_color(parent)); rb_set_black(parent); rb_set_black(other-rb_left); __rb_rotate_right(parent, root); node = root-rb_node; break; } } } if (node) rb_set_black(node); } void rb_erase(struct rb_node *node, struct rb_root *root) { struct rb_node *child, *parent; int color; if (!node-rb_left) child = node-rb_right; else if (!node-rb_right) child = node-rb_left; else { struct rb_node *old = node, *left; node = node-rb_right; while ((left = node-rb_left) != NULL) node = left; if (rb_parent(old)) { if (rb_parent(old)-rb_left == old) rb_parent(old)-rb_left = node; else rb_parent(old)-rb_right = node; } else root-rb_node = node; child = node-rb_right; parent = rb_parent(node); color = rb_color(node); if (parent == old) { parent = node; } else { if (child) rb_set_parent(child, parent); parent-rb_left = child; node-rb_right = old-rb_right; rb_set_parent(old-rb_right, node); } node-rb_parent_color = old-rb_parent_color; node-rb_left = old-rb_left; rb_set_parent(old-rb_left, node); goto color; } parent = rb_parent(node); color = rb_color(node); if (child) rb_set_parent(child, parent); if (parent) { if (parent-rb_left == node) parent-rb_left = child; else parent-rb_right = child; } else root-rb_node = child; color: if (color == RB_BLACK) __rb_erase_color(child, parent, root); } EXPORT_SYMBOL(rb_erase);   红黑树的查找的实现 下面是查找特定的结点的实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82  /* * This function returns the first node (in sort order) of the tree. */ struct rb_node *rb_first(const struct rb_root *root) { struct rb_node *n; n = root-rb_node; if (!n) return NULL; while (n-rb_left) n = n-rb_left; return n; } EXPORT_SYMBOL(rb_first); struct rb_node *rb_last(const struct rb_root *root) { struct rb_node *n; n = root-rb_node; if (!n) return NULL; while (n-rb_right) n = n-rb_right; return n; } EXPORT_SYMBOL(rb_last); struct rb_node *rb_next(const struct rb_node *node) { struct rb_node *parent; if (rb_parent(node) == node) return NULL; /* If we have a right-hand child, go down and then left as far as we can. */ if (node-rb_right) { node = node-rb_right; while (node-rb_left) node=node-rb_left; return (struct rb_node *)node; } /* No right-hand children. Everything down and left is smaller than us, so any 'next' node must be in the general direction of our parent. Go up the tree; any time the ancestor is a right-hand child of its parent, keep going up. First time it's a left-hand child of its parent, said parent is our 'next' node. */ while ((parent = rb_parent(node)) \u0026\u0026 node == parent-rb_right) node = parent; return parent; } EXPORT_SYMBOL(rb_next); struct rb_node *rb_prev(const struct rb_node *node) { struct rb_node *parent; if (rb_parent(node) == node) return NULL; /* If we have a left-hand child, go down and then right as far as we can. */ if (node-rb_left) { node = node-rb_left; while (node-rb_right) node=node-rb_right; return (struct rb_node *)node; } /* No left-hand children. Go up till we find an ancestor which is a right-hand child of its parent */ while ((parent = rb_parent(node)) \u0026\u0026 node == parent-rb_left) node = parent; return parent; } EXPORT_SYMBOL(rb_prev);   替换单个结点的实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  void rb_replace_node(struct rb_node *victim, struct rb_node *new, struct rb_root *root) { struct rb_node *parent = rb_parent(victim); /* Set the surrounding nodes to point to the replacement */ if (parent) { if (victim == parent-rb_left) parent-rb_left = new; else parent-rb_right = new; } else { root-rb_node = new; } if (victim-rb_left) rb_set_parent(victim-rb_left, new); if (victim-rb_right) rb_set_parent(victim-rb_right, new); /* Copy the pointers/colour from the victim to the replacement */ *new = *victim; } EXPORT_SYMBOL(rb_replace_node);   ","wordCount":"1789","inLanguage":"zh-cn","datePublished":"2020-11-04T00:00:00Z","dateModified":"2020-11-04T00:00:00Z","author":{"@type":"Person","name":"FreeFlyingSheep"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://freeflyingsheep.github.io/posts/kernel/data-structure/rbtree/"},"publisher":{"@type":"Organization","name":"FreeFlyingSheep 的小站","logo":{"@type":"ImageObject","url":"https://freeflyingsheep.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://freeflyingsheep.github.io/ accesskey=h title="FreeFlyingSheep 的小站 (Alt + H)">FreeFlyingSheep 的小站</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://freeflyingsheep.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://freeflyingsheep.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://freeflyingsheep.github.io/series title=Series><span>Series</span></a></li><li><a href=https://freeflyingsheep.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://freeflyingsheep.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://freeflyingsheep.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://freeflyingsheep.github.io/posts/>Posts</a></div><h1 class=post-title>内核红黑树</h1><div class=post-meta>November 4, 2020&nbsp;·&nbsp;9 min&nbsp;·&nbsp;FreeFlyingSheep</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%ae%80%e4%bb%8b aria-label=红黑树简介>红黑树简介</a></li><li><a href=#%e5%86%85%e6%a0%b8%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label=内核红黑树的使用>内核红黑树的使用</a><ul><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%88%9b%e5%bb%ba aria-label=红黑树的创建>红黑树的创建</a></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e6%90%9c%e7%b4%a2 aria-label=红黑树的搜索>红黑树的搜索</a></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e6%8f%92%e5%85%a5 aria-label=红黑树的插入>红黑树的插入</a></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%88%a0%e9%99%a4 aria-label=红黑树的删除>红黑树的删除</a></li><li><a href=#%e6%9b%bf%e6%8d%a2%e5%8d%95%e4%b8%aa%e7%bb%93%e7%82%b9 aria-label=替换单个结点>替换单个结点</a></li></ul></li><li><a href=#%e5%86%85%e6%a0%b8%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=内核红黑树的实现>内核红黑树的实现</a><ul><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%ae%9a%e4%b9%89 aria-label=红黑树的定义>红黑树的定义</a></li><li><a href=#%e8%be%85%e5%8a%a9%e5%87%bd%e6%95%b0%e5%ae%8f%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=辅助函数/宏的实现>辅助函数/宏的实现</a></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e6%97%8b%e8%bd%ac%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=红黑树的旋转的实现>红黑树的旋转的实现</a><ul><li><a href=#%e5%b7%a6%e6%97%8b aria-label=左旋>左旋</a></li><li><a href=#%e5%8f%b3%e6%97%8b aria-label=右旋>右旋</a></li></ul></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e6%8f%92%e5%85%a5%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=红黑树的插入的实现>红黑树的插入的实现</a><ul><li><a href=#%e6%8f%92%e5%85%a5%e7%bb%93%e7%82%b9%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=插入结点的实现>插入结点的实现</a></li><li><a href=#%e5%86%8d%e5%b9%b3%e8%a1%a1%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=再平衡的实现>再平衡的实现</a></li></ul></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%88%a0%e9%99%a4%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=红黑树的删除的实现>红黑树的删除的实现</a></li><li><a href=#%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e6%9f%a5%e6%89%be%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=红黑树的查找的实现>红黑树的查找的实现</a></li><li><a href=#%e6%9b%bf%e6%8d%a2%e5%8d%95%e4%b8%aa%e7%bb%93%e7%82%b9%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=替换单个结点的实现>替换单个结点的实现</a></li></ul></li></ul></div></details></div><div class=post-content><p><a href=/posts/kernel/kernel>Linux 内核学习笔记系列</a>，GCC 扩展语法和内核数据结构部分，简单介绍 Linux 内核红黑树。</p><h2 id=红黑树简介>红黑树简介<a hidden class=anchor aria-hidden=true href=#红黑树简介>#</a></h2><p>红黑树是一种着色的自平衡的二叉搜索树，Linux 主要的平衡二叉树数据结构就是红黑树。</p><p>红黑树满足以下几个条件：</p><ol><li>每一个结点或者着成红色，或者着成黑色。</li><li>根结点和叶结点是黑色的。</li><li>如果一个结点是红色的，那么它的子结点必须是黑色的。</li><li>从一个结点到一个叶结点的每一条路径必须包含相同数目的黑色结点。</li></ol><p>以上条件保证了红黑树最深的叶结点深度不会大于两倍的最浅叶结点深度（最长路径不会超过最短路径的两倍）。注意，叶结点不存储数据，都是 <code>NULL</code> 指针。</p><p>红黑树的优点是插入、删除、搜索元素都可以在对数时间内完成，缺点是实现复杂。</p><p>显然，红黑树完整的定义和性质的证明，不属于本系列学习笔记的范畴，可以参考数据结构书。</p><h2 id=内核红黑树的使用>内核红黑树的使用<a hidden class=anchor aria-hidden=true href=#内核红黑树的使用>#</a></h2><p>内核红黑树的实现称为 <code>rbtree</code>，头文件为 <code>include/linux/rbtree.h</code>。内核红黑树的搜索和插入操作是没有给出完整实现的，一方面是出于 C 语言不方便泛型编程，另一方面是内核开发者相信最有效的搜索和插入方法需要由用户自行实现。用户可以使用提供的辅助函数，但需要自行实现比较操作算子。</p><h3 id=红黑树的创建>红黑树的创建<a hidden class=anchor aria-hidden=true href=#红黑树的创建>#</a></h3><p>创建一个红黑树，需要为其分配一个根结点，并将其初始化为 <code>RB_ROOT</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> rb_root root <span style=color:#f92672>=</span> RB_ROOT;
</code></pre></td></tr></table></div></div><h3 id=红黑树的搜索>红黑树的搜索<a hidden class=anchor aria-hidden=true href=#红黑树的搜索>#</a></h3><p>下面是一个搜索的例子，<code>rb_search_page_cache</code> 函数实现了在页高速缓存中搜索一个文件区（由一个 i 结点和一个偏移量共同描述）。每个 i 结点都有自己的 <code>rbtree</code>，以关联在文件中的页偏移。该函数将搜索给定 i 结点的 <code>rbtree</code>，以寻找匹配的偏移值：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_search_page_cache</span>(<span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span> inode,
                                                 <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> offset)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>n <span style=color:#f92672>=</span> inode<span style=color:#f92672>-&gt;</span>i_rb_page_cache.rb_node;
    <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span>page;

    <span style=color:#66d9ef>while</span> (n)
    {
        page <span style=color:#f92672>=</span> rb_entry(n, <span style=color:#66d9ef>struct</span> page, rb_page_cache);

        <span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&lt;</span> page<span style=color:#f92672>-&gt;</span>offset)
            n <span style=color:#f92672>=</span> n<span style=color:#f92672>-&gt;</span>rb_left;
        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&gt;</span> page<span style=color:#f92672>-&gt;</span>offset)
            n <span style=color:#f92672>=</span> n<span style=color:#f92672>-&gt;</span>rb_right;
        <span style=color:#66d9ef>else</span>
            <span style=color:#66d9ef>return</span> page;
    }
    <span style=color:#66d9ef>return</span> NULL;
}
</code></pre></td></tr></table></div></div><p>辅助宏 <code>rb_entry</code> 和内核链表的 <code>list_entry</code> 相似，获取包含结点的数据结构。</p><p>查找特定的（前一个/后一个/第一个/最后一个）结点可以使用如下函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_next</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node);
<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_prev</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node);
<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_first</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root);
<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_last</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root);
</code></pre></td></tr></table></div></div><h3 id=红黑树的插入>红黑树的插入<a hidden class=anchor aria-hidden=true href=#红黑树的插入>#</a></h3><p>插入函数需要实现搜索和插入逻辑。还是以上面的情景，对应的插入函数如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span><span style=color:#a6e22e>__rb_insert_page_cache</span>(<span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span>inode,
                                                   <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> offset,
                                                   <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>**</span>p <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>inode<span style=color:#f92672>-&gt;</span>i_rb_page_cache.rb_node;
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent <span style=color:#f92672>=</span> NULL;
    <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span>page;

    <span style=color:#66d9ef>while</span> (<span style=color:#f92672>*</span>p)
    {
        parent <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>p;
        page <span style=color:#f92672>=</span> rb_entry(parent, <span style=color:#66d9ef>struct</span> page, rb_page_cache);

        <span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&lt;</span> page<span style=color:#f92672>-&gt;</span>offset)
            p <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>(<span style=color:#f92672>*</span>p)<span style=color:#f92672>-&gt;</span>rb_left;
        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&gt;</span> page<span style=color:#f92672>-&gt;</span>offset)
            p <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>(<span style=color:#f92672>*</span>p)<span style=color:#f92672>-&gt;</span>rb_right;
        <span style=color:#66d9ef>else</span>
            <span style=color:#66d9ef>return</span> page;
    }

    rb_link_node(node, parent, p);

    <span style=color:#66d9ef>return</span> NULL;
}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_insert_page_cache</span>(<span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span>inode,
                                                <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> offset,
                                                <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node)
{
    <span style=color:#66d9ef>struct</span> page <span style=color:#f92672>*</span>ret;
    <span style=color:#66d9ef>if</span> ((ret <span style=color:#f92672>=</span> __rb_insert_page_cache(inode, offset, node)))
        <span style=color:#66d9ef>goto</span> out;
    rb_insert_color(node, <span style=color:#f92672>&amp;</span>inode<span style=color:#f92672>-&gt;</span>i_rb_page_cache);
 out:
    <span style=color:#66d9ef>return</span> ret;
}
</code></pre></td></tr></table></div></div><p>辅助函数 <code>rb_link_node()</code> 负责在给定位置插入新结点，<code>rb_insert_color()</code> 负责执行复杂的再平衡操作。</p><h3 id=红黑树的删除>红黑树的删除<a hidden class=anchor aria-hidden=true href=#红黑树的删除>#</a></h3><p>删除结点只需要调用以下函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_erase</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root);
</code></pre></td></tr></table></div></div><h3 id=替换单个结点>替换单个结点<a hidden class=anchor aria-hidden=true href=#替换单个结点>#</a></h3><p>替换单个结点只需要调用以下函数，该函数不会进行再平衡操作：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_replace_node</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>victim, <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>new, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root);
</code></pre></td></tr></table></div></div><h2 id=内核红黑树的实现>内核红黑树的实现<a hidden class=anchor aria-hidden=true href=#内核红黑树的实现>#</a></h2><p>内核红黑树的实现均位于 <code>lib/rbtree.c</code> 和 <code>include/linux/rbtree.h</code>。本系列学习笔记的重点不在数据结构，下面给出的代码的原理可以参考数据结构书，此处不做详细介绍。个人认为通常情况下，了解红黑树基本概念和如何使用提供的函数就足够了。</p><h3 id=红黑树的定义>红黑树的定义<a hidden class=anchor aria-hidden=true href=#红黑树的定义>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> rb_node
{
    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>  rb_parent_color;
<span style=color:#75715e>#define RB_RED      0
</span><span style=color:#75715e>#define RB_BLACK    1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>rb_right;
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>rb_left;
} __attribute__((aligned(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>long</span>))));
    <span style=color:#75715e>/* The alignment might seem pointless, but allegedly CRIS needs it */</span>

<span style=color:#66d9ef>struct</span> rb_root
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>rb_node;
};
</code></pre></td></tr></table></div></div><p>其中，<code>rb_parent_color</code> 包含了两部分，一个是指向父结点的指针，另一个是当前结点的颜色，它是 <code>rb_parent_color</code> 的低 <code>2</code> 位。因为在所有体系结构上，指针都是至少 <code>4</code> 字节对齐的，所以这么做是可行的。</p><p>正如注释所吐槽的，对齐到 <code>sizeof(long)</code> 似乎是多余的，或许这也是个历史遗留问题。</p><h3 id=辅助函数宏的实现>辅助函数/宏的实现<a hidden class=anchor aria-hidden=true href=#辅助函数宏的实现>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#define rb_parent(r)       ((struct rb_node *)((r)-&gt;rb_parent_color &amp; ~3))
</span><span style=color:#75715e>#define rb_color(r)        ((r)-&gt;rb_parent_color &amp; 1)
</span><span style=color:#75715e>#define rb_is_red(r)       (!rb_color(r))
</span><span style=color:#75715e>#define rb_is_black(r)     rb_color(r)
</span><span style=color:#75715e>#define rb_set_red(r)      do { (r)-&gt;rb_parent_color &amp;= ~1; } while (0)
</span><span style=color:#75715e>#define rb_set_black(r)    do { (r)-&gt;rb_parent_color |= 1; } while (0)
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_set_parent</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>rb, <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>p)
{
    rb<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>=</span> (rb<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>|</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)p;
}
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_set_color</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>rb, <span style=color:#66d9ef>int</span> color)
{
    rb<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>=</span> (rb<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>|</span> color;
}

<span style=color:#75715e>#define RB_ROOT (struct rb_root) { NULL, }
</span><span style=color:#75715e>#define rb_entry(ptr, type, member) container_of(ptr, type, member)
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define RB_EMPTY_ROOT(root) ((root)-&gt;rb_node == NULL)
</span><span style=color:#75715e>#define RB_EMPTY_NODE(node) (rb_parent(node) == node)
</span><span style=color:#75715e>#define RB_CLEAR_NODE(node) (rb_set_parent(node, node))
</span></code></pre></td></tr></table></div></div><p>根据字面意思就可以理解这些辅助函数/宏的用途。</p><h3 id=红黑树的旋转的实现>红黑树的旋转的实现<a hidden class=anchor aria-hidden=true href=#红黑树的旋转的实现>#</a></h3><h4 id=左旋>左旋<a hidden class=anchor aria-hidden=true href=#左旋>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__rb_rotate_left</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>right <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right;
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent <span style=color:#f92672>=</span> rb_parent(node);

    <span style=color:#66d9ef>if</span> ((node<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> right<span style=color:#f92672>-&gt;</span>rb_left))
        rb_set_parent(right<span style=color:#f92672>-&gt;</span>rb_left, node);
    right<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> node;

    rb_set_parent(right, parent);

    <span style=color:#66d9ef>if</span> (parent)
    {
        <span style=color:#66d9ef>if</span> (node <span style=color:#f92672>==</span> parent<span style=color:#f92672>-&gt;</span>rb_left)
            parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> right;
        <span style=color:#66d9ef>else</span>
            parent<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> right;
    }
    <span style=color:#66d9ef>else</span>
        root<span style=color:#f92672>-&gt;</span>rb_node <span style=color:#f92672>=</span> right;
    rb_set_parent(node, right);
}
</code></pre></td></tr></table></div></div><h4 id=右旋>右旋<a hidden class=anchor aria-hidden=true href=#右旋>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__rb_rotate_right</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>left <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_left;
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent <span style=color:#f92672>=</span> rb_parent(node);

    <span style=color:#66d9ef>if</span> ((node<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> left<span style=color:#f92672>-&gt;</span>rb_right))
        rb_set_parent(left<span style=color:#f92672>-&gt;</span>rb_right, node);
    left<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> node;

    rb_set_parent(left, parent);

    <span style=color:#66d9ef>if</span> (parent)
    {
        <span style=color:#66d9ef>if</span> (node <span style=color:#f92672>==</span> parent<span style=color:#f92672>-&gt;</span>rb_right)
            parent<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> left;
        <span style=color:#66d9ef>else</span>
            parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> left;
    }
    <span style=color:#66d9ef>else</span>
        root<span style=color:#f92672>-&gt;</span>rb_node <span style=color:#f92672>=</span> left;
    rb_set_parent(node, left);
}
</code></pre></td></tr></table></div></div><h3 id=红黑树的插入的实现>红黑树的插入的实现<a hidden class=anchor aria-hidden=true href=#红黑树的插入的实现>#</a></h3><p>下面给出插入的辅助函数的实现。</p><h4 id=插入结点的实现>插入结点的实现<a hidden class=anchor aria-hidden=true href=#插入结点的实现>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_link_node</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span> node, <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span> parent,
                <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>**</span> rb_link)
{
    node<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> )parent;
    node<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> NULL;

    <span style=color:#f92672>*</span>rb_link <span style=color:#f92672>=</span> node;
}
</code></pre></td></tr></table></div></div><h4 id=再平衡的实现>再平衡的实现<a hidden class=anchor aria-hidden=true href=#再平衡的实现>#</a></h4><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_insert_color</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent, <span style=color:#f92672>*</span>gparent;

    <span style=color:#66d9ef>while</span> ((parent <span style=color:#f92672>=</span> rb_parent(node)) <span style=color:#f92672>&amp;&amp;</span> rb_is_red(parent))
    {
        gparent <span style=color:#f92672>=</span> rb_parent(parent);

        <span style=color:#66d9ef>if</span> (parent <span style=color:#f92672>==</span> gparent<span style=color:#f92672>-&gt;</span>rb_left)
        {
            {
                <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>uncle <span style=color:#f92672>=</span> gparent<span style=color:#f92672>-&gt;</span>rb_right;
                <span style=color:#66d9ef>if</span> (uncle <span style=color:#f92672>&amp;&amp;</span> rb_is_red(uncle))
                {
                    rb_set_black(uncle);
                    rb_set_black(parent);
                    rb_set_red(gparent);
                    node <span style=color:#f92672>=</span> gparent;
                    <span style=color:#66d9ef>continue</span>;
                }
            }

            <span style=color:#66d9ef>if</span> (parent<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>==</span> node)
            {
                <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>tmp;
                __rb_rotate_left(parent, root);
                tmp <span style=color:#f92672>=</span> parent;
                parent <span style=color:#f92672>=</span> node;
                node <span style=color:#f92672>=</span> tmp;
            }

            rb_set_black(parent);
            rb_set_red(gparent);
            __rb_rotate_right(gparent, root);
        } <span style=color:#66d9ef>else</span> {
            {
                <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>uncle <span style=color:#f92672>=</span> gparent<span style=color:#f92672>-&gt;</span>rb_left;
                <span style=color:#66d9ef>if</span> (uncle <span style=color:#f92672>&amp;&amp;</span> rb_is_red(uncle))
                {
                    rb_set_black(uncle);
                    rb_set_black(parent);
                    rb_set_red(gparent);
                    node <span style=color:#f92672>=</span> gparent;
                    <span style=color:#66d9ef>continue</span>;
                }
            }

            <span style=color:#66d9ef>if</span> (parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>==</span> node)
            {
                <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>tmp;
                __rb_rotate_right(parent, root);
                tmp <span style=color:#f92672>=</span> parent;
                parent <span style=color:#f92672>=</span> node;
                node <span style=color:#f92672>=</span> tmp;
            }

            rb_set_black(parent);
            rb_set_red(gparent);
            __rb_rotate_left(gparent, root);
        }
    }

    rb_set_black(root<span style=color:#f92672>-&gt;</span>rb_node);
}
EXPORT_SYMBOL(rb_insert_color);
</code></pre></td></tr></table></div></div><h3 id=红黑树的删除的实现>红黑树的删除的实现<a hidden class=anchor aria-hidden=true href=#红黑树的删除的实现>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__rb_erase_color</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent,
                 <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>other;

    <span style=color:#66d9ef>while</span> ((<span style=color:#f92672>!</span>node <span style=color:#f92672>||</span> rb_is_black(node)) <span style=color:#f92672>&amp;&amp;</span> node <span style=color:#f92672>!=</span> root<span style=color:#f92672>-&gt;</span>rb_node)
    {
        <span style=color:#66d9ef>if</span> (parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>==</span> node)
        {
            other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_right;
            <span style=color:#66d9ef>if</span> (rb_is_red(other))
            {
                rb_set_black(other);
                rb_set_red(parent);
                __rb_rotate_left(parent, root);
                other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_right;
            }
            <span style=color:#66d9ef>if</span> ((<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_left)) <span style=color:#f92672>&amp;&amp;</span>
                (<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_right)))
            {
                rb_set_red(other);
                node <span style=color:#f92672>=</span> parent;
                parent <span style=color:#f92672>=</span> rb_parent(node);
            }
            <span style=color:#66d9ef>else</span>
            {
                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_right))
                {
                    rb_set_black(other<span style=color:#f92672>-&gt;</span>rb_left);
                    rb_set_red(other);
                    __rb_rotate_right(other, root);
                    other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_right;
                }
                rb_set_color(other, rb_color(parent));
                rb_set_black(parent);
                rb_set_black(other<span style=color:#f92672>-&gt;</span>rb_right);
                __rb_rotate_left(parent, root);
                node <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>rb_node;
                <span style=color:#66d9ef>break</span>;
            }
        }
        <span style=color:#66d9ef>else</span>
        {
            other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_left;
            <span style=color:#66d9ef>if</span> (rb_is_red(other))
            {
                rb_set_black(other);
                rb_set_red(parent);
                __rb_rotate_right(parent, root);
                other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_left;
            }
            <span style=color:#66d9ef>if</span> ((<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_left)) <span style=color:#f92672>&amp;&amp;</span>
                (<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_right)))
            {
                rb_set_red(other);
                node <span style=color:#f92672>=</span> parent;
                parent <span style=color:#f92672>=</span> rb_parent(node);
            }
            <span style=color:#66d9ef>else</span>
            {
                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>other<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>||</span> rb_is_black(other<span style=color:#f92672>-&gt;</span>rb_left))
                {
                    rb_set_black(other<span style=color:#f92672>-&gt;</span>rb_right);
                    rb_set_red(other);
                    __rb_rotate_left(other, root);
                    other <span style=color:#f92672>=</span> parent<span style=color:#f92672>-&gt;</span>rb_left;
                }
                rb_set_color(other, rb_color(parent));
                rb_set_black(parent);
                rb_set_black(other<span style=color:#f92672>-&gt;</span>rb_left);
                __rb_rotate_right(parent, root);
                node <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>rb_node;
                <span style=color:#66d9ef>break</span>;
            }
        }
    }
    <span style=color:#66d9ef>if</span> (node)
        rb_set_black(node);
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_erase</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node, <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>child, <span style=color:#f92672>*</span>parent;
    <span style=color:#66d9ef>int</span> color;

    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>node<span style=color:#f92672>-&gt;</span>rb_left)
        child <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right;
    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>node<span style=color:#f92672>-&gt;</span>rb_right)
        child <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_left;
    <span style=color:#66d9ef>else</span>
    {
        <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>old <span style=color:#f92672>=</span> node, <span style=color:#f92672>*</span>left;

        node <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right;
        <span style=color:#66d9ef>while</span> ((left <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_left) <span style=color:#f92672>!=</span> NULL)
            node <span style=color:#f92672>=</span> left;

        <span style=color:#66d9ef>if</span> (rb_parent(old)) {
            <span style=color:#66d9ef>if</span> (rb_parent(old)<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>==</span> old)
                rb_parent(old)<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> node;
            <span style=color:#66d9ef>else</span>
                rb_parent(old)<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> node;
        } <span style=color:#66d9ef>else</span>
            root<span style=color:#f92672>-&gt;</span>rb_node <span style=color:#f92672>=</span> node;

        child <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right;
        parent <span style=color:#f92672>=</span> rb_parent(node);
        color <span style=color:#f92672>=</span> rb_color(node);

        <span style=color:#66d9ef>if</span> (parent <span style=color:#f92672>==</span> old) {
            parent <span style=color:#f92672>=</span> node;
        } <span style=color:#66d9ef>else</span> {
            <span style=color:#66d9ef>if</span> (child)
                rb_set_parent(child, parent);
            parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> child;

            node<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> old<span style=color:#f92672>-&gt;</span>rb_right;
            rb_set_parent(old<span style=color:#f92672>-&gt;</span>rb_right, node);
        }

        node<span style=color:#f92672>-&gt;</span>rb_parent_color <span style=color:#f92672>=</span> old<span style=color:#f92672>-&gt;</span>rb_parent_color;
        node<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> old<span style=color:#f92672>-&gt;</span>rb_left;
        rb_set_parent(old<span style=color:#f92672>-&gt;</span>rb_left, node);

        <span style=color:#66d9ef>goto</span> color;
    }

    parent <span style=color:#f92672>=</span> rb_parent(node);
    color <span style=color:#f92672>=</span> rb_color(node);

    <span style=color:#66d9ef>if</span> (child)
        rb_set_parent(child, parent);
    <span style=color:#66d9ef>if</span> (parent)
    {
        <span style=color:#66d9ef>if</span> (parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>==</span> node)
            parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> child;
        <span style=color:#66d9ef>else</span>
            parent<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> child;
    }
    <span style=color:#66d9ef>else</span>
        root<span style=color:#f92672>-&gt;</span>rb_node <span style=color:#f92672>=</span> child;

 color:
    <span style=color:#66d9ef>if</span> (color <span style=color:#f92672>==</span> RB_BLACK)
        __rb_erase_color(child, parent, root);
}
EXPORT_SYMBOL(rb_erase);
</code></pre></td></tr></table></div></div><h3 id=红黑树的查找的实现>红黑树的查找的实现<a hidden class=anchor aria-hidden=true href=#红黑树的查找的实现>#</a></h3><p>下面是查找特定的结点的实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * This function returns the first node (in sort order) of the tree.
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_first</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>n;

    n <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>rb_node;
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>n)
        <span style=color:#66d9ef>return</span> NULL;
    <span style=color:#66d9ef>while</span> (n<span style=color:#f92672>-&gt;</span>rb_left)
        n <span style=color:#f92672>=</span> n<span style=color:#f92672>-&gt;</span>rb_left;
    <span style=color:#66d9ef>return</span> n;
}
EXPORT_SYMBOL(rb_first);

<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_last</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>n;

    n <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>rb_node;
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>n)
        <span style=color:#66d9ef>return</span> NULL;
    <span style=color:#66d9ef>while</span> (n<span style=color:#f92672>-&gt;</span>rb_right)
        n <span style=color:#f92672>=</span> n<span style=color:#f92672>-&gt;</span>rb_right;
    <span style=color:#66d9ef>return</span> n;
}
EXPORT_SYMBOL(rb_last);

<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_next</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent;

    <span style=color:#66d9ef>if</span> (rb_parent(node) <span style=color:#f92672>==</span> node)
        <span style=color:#66d9ef>return</span> NULL;

    <span style=color:#75715e>/* If we have a right-hand child, go down and then left as far
</span><span style=color:#75715e>       as we can. */</span>
    <span style=color:#66d9ef>if</span> (node<span style=color:#f92672>-&gt;</span>rb_right) {
        node <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_right;
        <span style=color:#66d9ef>while</span> (node<span style=color:#f92672>-&gt;</span>rb_left)
            node<span style=color:#f92672>=</span>node<span style=color:#f92672>-&gt;</span>rb_left;
        <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>)node;
    }

    <span style=color:#75715e>/* No right-hand children.  Everything down and left is
</span><span style=color:#75715e>       smaller than us, so any &#39;next&#39; node must be in the general
</span><span style=color:#75715e>       direction of our parent. Go up the tree; any time the
</span><span style=color:#75715e>       ancestor is a right-hand child of its parent, keep going
</span><span style=color:#75715e>       up. First time it&#39;s a left-hand child of its parent, said
</span><span style=color:#75715e>       parent is our &#39;next&#39; node. */</span>
    <span style=color:#66d9ef>while</span> ((parent <span style=color:#f92672>=</span> rb_parent(node)) <span style=color:#f92672>&amp;&amp;</span> node <span style=color:#f92672>==</span> parent<span style=color:#f92672>-&gt;</span>rb_right)
        node <span style=color:#f92672>=</span> parent;

    <span style=color:#66d9ef>return</span> parent;
}
EXPORT_SYMBOL(rb_next);

<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span><span style=color:#a6e22e>rb_prev</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>node)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent;

    <span style=color:#66d9ef>if</span> (rb_parent(node) <span style=color:#f92672>==</span> node)
        <span style=color:#66d9ef>return</span> NULL;

    <span style=color:#75715e>/* If we have a left-hand child, go down and then right as far
</span><span style=color:#75715e>       as we can. */</span>
    <span style=color:#66d9ef>if</span> (node<span style=color:#f92672>-&gt;</span>rb_left) {
        node <span style=color:#f92672>=</span> node<span style=color:#f92672>-&gt;</span>rb_left;
        <span style=color:#66d9ef>while</span> (node<span style=color:#f92672>-&gt;</span>rb_right)
            node<span style=color:#f92672>=</span>node<span style=color:#f92672>-&gt;</span>rb_right;
        <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>)node;
    }

    <span style=color:#75715e>/* No left-hand children. Go up till we find an ancestor which
</span><span style=color:#75715e>       is a right-hand child of its parent */</span>
    <span style=color:#66d9ef>while</span> ((parent <span style=color:#f92672>=</span> rb_parent(node)) <span style=color:#f92672>&amp;&amp;</span> node <span style=color:#f92672>==</span> parent<span style=color:#f92672>-&gt;</span>rb_left)
        node <span style=color:#f92672>=</span> parent;

    <span style=color:#66d9ef>return</span> parent;
}
EXPORT_SYMBOL(rb_prev);
</code></pre></td></tr></table></div></div><h3 id=替换单个结点的实现>替换单个结点的实现<a hidden class=anchor aria-hidden=true href=#替换单个结点的实现>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>rb_replace_node</span>(<span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>victim, <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>new,
             <span style=color:#66d9ef>struct</span> rb_root <span style=color:#f92672>*</span>root)
{
    <span style=color:#66d9ef>struct</span> rb_node <span style=color:#f92672>*</span>parent <span style=color:#f92672>=</span> rb_parent(victim);

    <span style=color:#75715e>/* Set the surrounding nodes to point to the replacement */</span>
    <span style=color:#66d9ef>if</span> (parent) {
        <span style=color:#66d9ef>if</span> (victim <span style=color:#f92672>==</span> parent<span style=color:#f92672>-&gt;</span>rb_left)
            parent<span style=color:#f92672>-&gt;</span>rb_left <span style=color:#f92672>=</span> new;
        <span style=color:#66d9ef>else</span>
            parent<span style=color:#f92672>-&gt;</span>rb_right <span style=color:#f92672>=</span> new;
    } <span style=color:#66d9ef>else</span> {
        root<span style=color:#f92672>-&gt;</span>rb_node <span style=color:#f92672>=</span> new;
    }
    <span style=color:#66d9ef>if</span> (victim<span style=color:#f92672>-&gt;</span>rb_left)
        rb_set_parent(victim<span style=color:#f92672>-&gt;</span>rb_left, new);
    <span style=color:#66d9ef>if</span> (victim<span style=color:#f92672>-&gt;</span>rb_right)
        rb_set_parent(victim<span style=color:#f92672>-&gt;</span>rb_right, new);

    <span style=color:#75715e>/* Copy the pointers/colour from the victim to the replacement */</span>
    <span style=color:#f92672>*</span>new <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>victim;
}
EXPORT_SYMBOL(rb_replace_node);
</code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://freeflyingsheep.github.io/tags/linux-%E5%86%85%E6%A0%B8/>Linux 内核</a></li><li><a href=https://freeflyingsheep.github.io/tags/%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>内核数据结构</a></li><li><a href=https://freeflyingsheep.github.io/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/>红黑树</a></li></ul><nav class=paginav><a class=prev href=https://freeflyingsheep.github.io/posts/openstack/introduction/><span class=title>«</span><br><span>OpenStack 简介</span></a>
<a class=next href=https://freeflyingsheep.github.io/posts/kernel/memory/address/><span class=title>»</span><br><span>内存寻址</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://freeflyingsheep.github.io/>FreeFlyingSheep 的小站</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>