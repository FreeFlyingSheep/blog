<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>内核编译和调试 | FreeFlyingSheep 的小站</title><meta name=keywords content="Linux 内核,内核开发"><meta name=description content="Linux 内核学习笔记系列，内核开发部分，简单介绍 Linux 内核编译步骤。"><meta name=author content="FreeFlyingSheep"><link rel=canonical href=https://freeflyingsheep.github.io/posts/kernel/develop/build/><link crossorigin=anonymous href=/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as=style><link rel=preload href=/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://freeflyingsheep.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://freeflyingsheep.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://freeflyingsheep.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://freeflyingsheep.github.io/apple-touch-icon.png><link rel=mask-icon href=https://freeflyingsheep.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><meta property="og:title" content="内核编译和调试"><meta property="og:description" content="Linux 内核学习笔记系列，内核开发部分，简单介绍 Linux 内核编译步骤。"><meta property="og:type" content="article"><meta property="og:url" content="https://freeflyingsheep.github.io/posts/kernel/develop/build/"><meta property="og:image" content="https://freeflyingsheep.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-19T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://freeflyingsheep.github.io/papermod-cover.png"><meta name=twitter:title content="内核编译和调试"><meta name=twitter:description content="Linux 内核学习笔记系列，内核开发部分，简单介绍 Linux 内核编译步骤。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://freeflyingsheep.github.io/posts/"},{"@type":"ListItem","position":2,"name":"内核编译和调试","item":"https://freeflyingsheep.github.io/posts/kernel/develop/build/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"内核编译和调试","name":"内核编译和调试","description":"Linux 内核学习笔记系列，内核开发部分，简单介绍 Linux 内核编译步骤。\n","keywords":["Linux 内核","内核开发"],"articleBody":"Linux 内核学习笔记系列，内核开发部分，简单介绍 Linux 内核编译步骤。\n内核源码树    目录 内容     arch 体系结构相关的代码，包括头文件、C 和汇编源文件   block 块设备 I/O 层   crypto 加密层   Documentation 内核源码文档   drivers 设备驱动程序   firmware 使用某些驱动程序而需要的设备固件   fs 文件系统   include 内核头文件   init 内核引导和初始化   ipc 进程间通信   kernel 内核核心组件   lib 内核通用库   mm 内存管理子系统   net 网络子系统   samples 示例，示范代码   scripts 编译内核所用的脚本   security Linux 安全模块   sound 语音子系统，即声卡驱动程序   tools Linux 开发实用工具   usr 早期用户空间的代码   virt 虚拟化基础结构    配置内核 Kconfig 内核采用了一种被称为 Kconfig 的配置语言，该配置语言可以解决以下问题：\n 各组件可以持久编译到内核中、可以编译为组件或直接忽略掉（在某些环境下，可能无法将某些组件编译为模块）。 在配置选项之间，可能存在相互依赖关系（某些选项只能与一个或多个其他选项连同使用）。 必须能够给出一个可用选项列表，供用户从中选择（有些情形，需要提示用户输入编号或类似的值）。 必须能够层次化地编排各种配置选项（在一一个树型结构中）。 配置选项可能依体系结构而不同。 配置语言不应该过于复杂，因为编写配置脚本并非大多数内核程序员喜欢做的事情。  Kconfig 的具体语法和实现不属于本系列学习笔记的范畴，我考虑以后专门开一个专题介绍内核构建系统。\n配置内核的工具 内核提供了各种不同的工具来简化内核配置。\n最简单的是字符界面下的命令行工具：\n1  make config   该工具会逐一遍历所有配置项，要求用户选择 yes、no 或是 module（如果是三选一的话）。由于这个过程往往要耗费掉很长时间，所以，不建议使用该工具配置内核。\n常用的工具是基于 ncurse 库编制的图形界面工具：\n1  make menuconfig   或者，使用基于 gtk+ 的图形工具：\n1  make gconfig   其他配置方式 除了使用上述三个工具，还可以直接使用内核的默认配置：\n1  make defconfig   不论使用哪种配置方式，最终内核配置文件会位于内核代码树根目录下的 .config 文件。\n也可以直接复制或修改配置文件 .config，这么做之后，应该更新配置文件：\n1  make oldconfig   编译内核 Kbuild 内核使用 GNU make 来编译源代码，这是一个复杂的 Makefile 系统，我们把该系统称为 Kbuild 系统。\n同样，Kbuild 的具体实现不属于本系列学习笔记的范畴，我考虑以后专门开一个专题介绍内核构建系统。\n编译内核的命令 1  make [-jn]   可选的 -jn 参数代表用 n 个作业来并行编译。\n安装内核 安装内核映像 把内核映像拷贝到 /boot 目录下，修改相应的引导配置。\n安装内核模块 1  make modules_install   内核编译实例 上面的内容都是在本机上配置编译安装内核的步骤，下面展示一个交叉编译内核并安装的实例。\n现在我们有一个 x86 体系结构的主机，要为一台龙芯（3A4000）的机器安装内核（假设主机上的“指定目录”为 ../dest，内核映像将位于 ../dest/boot，内核模块将位于 ../dest/lib）：\n 设置交叉编译工具链的环境变量。 使用默认配置来配置内核：make ARCH=mips loongson3_defconfig。 使用 8 个作业来并行编译内核：make ARCH=mips CROSS_COMPILE=mips64el-unknown-linux-gnu- -j8。 复制内核映像到指定目录：cp vmlinuz ../dest/boot。 复制内核配置到指定目录：cp .config ../dest/boot（可选）。 安装模块到指定目录：make ARCH=mips CROSS_COMPILE=mips64el-unknown-linux-gnu- INSTALL_MOD_PATH=../dest -j8 modules_install。 打包 ../dest 目录并解包到目标机器。 安装内核映像（假设内核映像文件名为 vmlinuz-4.x）：cp boot/vmlinuz-4.x /boot（可选地复制内核配置文件到 /boot）。 安装内核模块（假设内核模块目录名为 4.19.150+）：cp -r lib/modules/4.19.150+ /lib/modules。 修改相应的引导配置。  内核调试 下面仅列举几个常用的调试方式。\n通过打印来调试 最好理解，用 printk() 函数在相应地方打印信息。\n借助 GDB 和 KGDB 这部分内容可以参考内核在线文档 Debugging kernel and modules via gdb 和 Using kgdb, kdb and the kernel debugger internals。\n使用 Git 进行二分搜索 首先，告诉 Git 使用二分搜索：\n1  git bisect start   其次，告诉 Git 出现问题的最早版本（如果当前版本就是，这步可以略过）：\n1  git bisect bad    然后，告诉 Git 可正常运行的最新版本：\n1  git bisect good    或者，将上述三步合成一步，直接告诉 Git 起点和终点（注意，终点 end 是最近的提交，而起点 begin 是更久以前的提交）：\n1  git bisect start     之后，Git 会自动进行二分搜索，切换到中间的某次提交。如果该提交一切正常，将它标记为“好的”：\n1  git bisect good   反之，将它标记为“坏的”：\n1  git bisect bad   之后，Git 会继续进行二分搜索，直接找到引入问题的那次提交。\n最后，退出二分搜索：\n1  git bisect reset   如果确定引发 bug 的源，那么可以指定 Git 仅在与错误相关的目录（path）进行二分搜索：\n1  git bisect start --    这种方法能定位引入 bug 的版本，但如果 bug 已经被修复，希望在上游代码中寻找修复该 bug 的提交，那只能手动二分搜索了。\n","wordCount":"277","inLanguage":"zh-cn","datePublished":"2020-10-19T00:00:00Z","dateModified":"2020-10-19T00:00:00Z","author":{"@type":"Person","name":"FreeFlyingSheep"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://freeflyingsheep.github.io/posts/kernel/develop/build/"},"publisher":{"@type":"Organization","name":"FreeFlyingSheep 的小站","logo":{"@type":"ImageObject","url":"https://freeflyingsheep.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://freeflyingsheep.github.io/ accesskey=h title="FreeFlyingSheep 的小站 (Alt + H)">FreeFlyingSheep 的小站</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://freeflyingsheep.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://freeflyingsheep.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://freeflyingsheep.github.io/series title=Series><span>Series</span></a></li><li><a href=https://freeflyingsheep.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://freeflyingsheep.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://freeflyingsheep.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://freeflyingsheep.github.io/posts/>Posts</a></div><h1 class=post-title>内核编译和调试</h1><div class=post-meta>October 19, 2020&nbsp;·&nbsp;2 min&nbsp;·&nbsp;FreeFlyingSheep</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#%e5%86%85%e6%a0%b8%e6%ba%90%e7%a0%81%e6%a0%91 aria-label=内核源码树>内核源码树</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8 aria-label=配置内核>配置内核</a><ul><li><a href=#kconfig aria-label=Kconfig>Kconfig</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8%e7%9a%84%e5%b7%a5%e5%85%b7 aria-label=配置内核的工具>配置内核的工具</a></li><li><a href=#%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f aria-label=其他配置方式>其他配置方式</a></li></ul></li><li><a href=#%e7%bc%96%e8%af%91%e5%86%85%e6%a0%b8 aria-label=编译内核>编译内核</a><ul><li><a href=#kbuild aria-label=Kbuild>Kbuild</a></li><li><a href=#%e7%bc%96%e8%af%91%e5%86%85%e6%a0%b8%e7%9a%84%e5%91%bd%e4%bb%a4 aria-label=编译内核的命令>编译内核的命令</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85%e5%86%85%e6%a0%b8 aria-label=安装内核>安装内核</a><ul><li><a href=#%e5%ae%89%e8%a3%85%e5%86%85%e6%a0%b8%e6%98%a0%e5%83%8f aria-label=安装内核映像>安装内核映像</a></li><li><a href=#%e5%ae%89%e8%a3%85%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97 aria-label=安装内核模块>安装内核模块</a></li></ul></li><li><a href=#%e5%86%85%e6%a0%b8%e7%bc%96%e8%af%91%e5%ae%9e%e4%be%8b aria-label=内核编译实例>内核编译实例</a></li><li><a href=#%e5%86%85%e6%a0%b8%e8%b0%83%e8%af%95 aria-label=内核调试>内核调试</a><ul><li><a href=#%e9%80%9a%e8%bf%87%e6%89%93%e5%8d%b0%e6%9d%a5%e8%b0%83%e8%af%95 aria-label=通过打印来调试>通过打印来调试</a></li><li><a href=#%e5%80%9f%e5%8a%a9-gdb-%e5%92%8c-kgdb aria-label="借助 GDB 和 KGDB">借助 GDB 和 KGDB</a></li><li><a href=#%e4%bd%bf%e7%94%a8-git-%e8%bf%9b%e8%a1%8c%e4%ba%8c%e5%88%86%e6%90%9c%e7%b4%a2 aria-label="使用 Git 进行二分搜索">使用 Git 进行二分搜索</a></li></ul></li></ul></div></details></div><div class=post-content><p><a href=/posts/kernel/kernel>Linux 内核学习笔记系列</a>，内核开发部分，简单介绍 Linux 内核编译步骤。</p><h2 id=内核源码树>内核源码树<a hidden class=anchor aria-hidden=true href=#内核源码树>#</a></h2><table><thead><tr><th>目录</th><th>内容</th></tr></thead><tbody><tr><td><code>arch</code></td><td>体系结构相关的代码，包括头文件、C 和汇编源文件</td></tr><tr><td><code>block</code></td><td>块设备 I/O 层</td></tr><tr><td><code>crypto</code></td><td>加密层</td></tr><tr><td><code>Documentation</code></td><td>内核源码文档</td></tr><tr><td><code>drivers</code></td><td>设备驱动程序</td></tr><tr><td><code>firmware</code></td><td>使用某些驱动程序而需要的设备固件</td></tr><tr><td><code>fs</code></td><td>文件系统</td></tr><tr><td><code>include</code></td><td>内核头文件</td></tr><tr><td><code>init</code></td><td>内核引导和初始化</td></tr><tr><td><code>ipc</code></td><td>进程间通信</td></tr><tr><td><code>kernel</code></td><td>内核核心组件</td></tr><tr><td><code>lib</code></td><td>内核通用库</td></tr><tr><td><code>mm</code></td><td>内存管理子系统</td></tr><tr><td><code>net</code></td><td>网络子系统</td></tr><tr><td><code>samples</code></td><td>示例，示范代码</td></tr><tr><td><code>scripts</code></td><td>编译内核所用的脚本</td></tr><tr><td><code>security</code></td><td>Linux 安全模块</td></tr><tr><td><code>sound</code></td><td>语音子系统，即声卡驱动程序</td></tr><tr><td><code>tools</code></td><td>Linux 开发实用工具</td></tr><tr><td><code>usr</code></td><td>早期用户空间的代码</td></tr><tr><td><code>virt</code></td><td>虚拟化基础结构</td></tr></tbody></table><h2 id=配置内核>配置内核<a hidden class=anchor aria-hidden=true href=#配置内核>#</a></h2><h3 id=kconfig>Kconfig<a hidden class=anchor aria-hidden=true href=#kconfig>#</a></h3><p>内核采用了一种被称为 Kconfig 的配置语言，该配置语言可以解决以下问题：</p><ul><li>各组件可以持久编译到内核中、可以编译为组件或直接忽略掉（在某些环境下，可能无法将某些组件编译为模块）。</li><li>在配置选项之间，可能存在相互依赖关系（某些选项只能与一个或多个其他选项连同使用）。</li><li>必须能够给出一个可用选项列表，供用户从中选择（有些情形，需要提示用户输入编号或类似的值）。</li><li>必须能够层次化地编排各种配置选项（在一一个树型结构中）。</li><li>配置选项可能依体系结构而不同。</li><li>配置语言不应该过于复杂，因为编写配置脚本并非大多数内核程序员喜欢做的事情。</li></ul><p>Kconfig 的具体语法和实现不属于本系列学习笔记的范畴，我考虑以后专门开一个专题介绍内核构建系统。</p><h3 id=配置内核的工具>配置内核的工具<a hidden class=anchor aria-hidden=true href=#配置内核的工具>#</a></h3><p>内核提供了各种不同的工具来简化内核配置。</p><p>最简单的是字符界面下的命令行工具：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make config
</code></pre></td></tr></table></div></div><p>该工具会逐一遍历所有配置项，要求用户选择 <code>yes</code>、<code>no</code> 或是 <code>module</code>（如果是三选一的话）。由于这个过程往往要耗费掉很长时间，所以，不建议使用该工具配置内核。</p><p>常用的工具是基于 ncurse 库编制的图形界面工具：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make menuconfig
</code></pre></td></tr></table></div></div><p>或者，使用基于 gtk+ 的图形工具：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make gconfig
</code></pre></td></tr></table></div></div><h3 id=其他配置方式>其他配置方式<a hidden class=anchor aria-hidden=true href=#其他配置方式>#</a></h3><p>除了使用上述三个工具，还可以直接使用内核的默认配置：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make defconfig
</code></pre></td></tr></table></div></div><p>不论使用哪种配置方式，最终内核配置文件会位于内核代码树根目录下的 <code>.config</code> 文件。</p><p>也可以直接复制或修改配置文件 <code>.config</code>，这么做之后，应该更新配置文件：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make oldconfig
</code></pre></td></tr></table></div></div><h2 id=编译内核>编译内核<a hidden class=anchor aria-hidden=true href=#编译内核>#</a></h2><h3 id=kbuild>Kbuild<a hidden class=anchor aria-hidden=true href=#kbuild>#</a></h3><p>内核使用 GNU make 来编译源代码，这是一个复杂的 Makefile 系统，我们把该系统称为 Kbuild 系统。</p><p>同样，Kbuild 的具体实现不属于本系列学习笔记的范畴，我考虑以后专门开一个专题介绍内核构建系统。</p><h3 id=编译内核的命令>编译内核的命令<a hidden class=anchor aria-hidden=true href=#编译内核的命令>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make <span style=color:#f92672>[</span>-jn<span style=color:#f92672>]</span>
</code></pre></td></tr></table></div></div><p>可选的 <code>-jn</code> 参数代表用 <code>n</code> 个作业来并行编译。</p><h2 id=安装内核>安装内核<a hidden class=anchor aria-hidden=true href=#安装内核>#</a></h2><h3 id=安装内核映像>安装内核映像<a hidden class=anchor aria-hidden=true href=#安装内核映像>#</a></h3><p>把内核映像拷贝到 <code>/boot</code> 目录下，修改相应的引导配置。</p><h3 id=安装内核模块>安装内核模块<a hidden class=anchor aria-hidden=true href=#安装内核模块>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make modules_install
</code></pre></td></tr></table></div></div><h2 id=内核编译实例>内核编译实例<a hidden class=anchor aria-hidden=true href=#内核编译实例>#</a></h2><p>上面的内容都是在本机上配置编译安装内核的步骤，下面展示一个<strong>交叉编译</strong>内核并安装的实例。</p><p>现在我们有一个 x86 体系结构的主机，要为一台龙芯（3A4000）的机器安装内核（假设主机上的“指定目录”为 <code>../dest</code>，内核映像将位于 <code>../dest/boot</code>，内核模块将位于 <code>../dest/lib</code>）：</p><ol><li>设置交叉编译工具链的环境变量。</li><li>使用默认配置来配置内核：<code>make ARCH=mips loongson3_defconfig</code>。</li><li>使用 <code>8</code> 个作业来并行编译内核：<code>make ARCH=mips CROSS_COMPILE=mips64el-unknown-linux-gnu- -j8</code>。</li><li>复制内核映像到指定目录：<code>cp vmlinuz ../dest/boot</code>。</li><li>复制内核配置到指定目录：<code>cp .config ../dest/boot</code>（可选）。</li><li>安装模块到指定目录：<code>make ARCH=mips CROSS_COMPILE=mips64el-unknown-linux-gnu- INSTALL_MOD_PATH=../dest -j8 modules_install</code>。</li><li>打包 <code>../dest</code> 目录并解包到目标机器。</li><li>安装内核映像（假设内核映像文件名为 <code>vmlinuz-4.x</code>）：<code>cp boot/vmlinuz-4.x /boot</code>（可选地复制内核配置文件到 <code>/boot</code>）。</li><li>安装内核模块（假设内核模块目录名为 <code>4.19.150+</code>）：<code>cp -r lib/modules/4.19.150+ /lib/modules</code>。</li><li>修改相应的引导配置。</li></ol><h2 id=内核调试>内核调试<a hidden class=anchor aria-hidden=true href=#内核调试>#</a></h2><p>下面仅列举几个常用的调试方式。</p><h3 id=通过打印来调试>通过打印来调试<a hidden class=anchor aria-hidden=true href=#通过打印来调试>#</a></h3><p>最好理解，用 <code>printk()</code> 函数在相应地方打印信息。</p><h3 id=借助-gdb-和-kgdb>借助 GDB 和 KGDB<a hidden class=anchor aria-hidden=true href=#借助-gdb-和-kgdb>#</a></h3><p>这部分内容可以参考内核在线文档 <a href=https://www.kernel.org/doc/html/latest/dev-tools/gdb-kernel-debugging.html>Debugging kernel and modules via gdb</a> 和 <a href=https://www.kernel.org/doc/html/latest/dev-tools/kgdb.html>Using kgdb, kdb and the kernel debugger internals</a>。</p><h3 id=使用-git-进行二分搜索>使用 Git 进行二分搜索<a hidden class=anchor aria-hidden=true href=#使用-git-进行二分搜索>#</a></h3><p>首先，告诉 Git 使用二分搜索：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect start
</code></pre></td></tr></table></div></div><p>其次，告诉 Git 出现问题的最早版本（如果当前版本就是，这步可以略过）：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect bad &lt;commit&gt;
</code></pre></td></tr></table></div></div><p>然后，告诉 Git 可正常运行的最新版本：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect good &lt;commit&gt;
</code></pre></td></tr></table></div></div><p>或者，将上述三步合成一步，直接告诉 Git 起点和终点（注意，终点 <code>end</code> 是最近的提交，而起点 <code>begin</code> 是更久以前的提交）：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect start &lt;end&gt; &lt;begin&gt;
</code></pre></td></tr></table></div></div><p>之后，Git 会自动进行二分搜索，切换到中间的某次提交。如果该提交一切正常，将它标记为“好的”：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect good
</code></pre></td></tr></table></div></div><p>反之，将它标记为“坏的”：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect bad
</code></pre></td></tr></table></div></div><p>之后，Git 会继续进行二分搜索，直接找到引入问题的那次提交。</p><p>最后，退出二分搜索：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect reset
</code></pre></td></tr></table></div></div><p>如果确定引发 bug 的源，那么可以指定 Git 仅在与错误相关的目录（<code>path</code>）进行二分搜索：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git bisect start -- &lt;path&gt;
</code></pre></td></tr></table></div></div><p>这种方法能定位引入 bug 的版本，但如果 bug 已经被修复，希望在上游代码中寻找修复该 bug 的提交，那只能手动二分搜索了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://freeflyingsheep.github.io/tags/linux-%E5%86%85%E6%A0%B8/>Linux 内核</a></li><li><a href=https://freeflyingsheep.github.io/tags/%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91/>内核开发</a></li></ul><nav class=paginav><a class=prev href=https://freeflyingsheep.github.io/posts/linux/arch/><span class=title>«</span><br><span>安装 Arch Linux</span></a>
<a class=next href=https://freeflyingsheep.github.io/posts/kernel/data-structure/hlist/><span class=title>»</span><br><span>内核散列表</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://freeflyingsheep.github.io/>FreeFlyingSheep 的小站</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>