<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>在龙芯上移植 OpenStack | FreeFlyingSheep 的小站</title><meta name=keywords content="OpenStack"><meta name=description content="整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。"><meta name=author content="FreeFlyingSheep"><link rel=canonical href=https://freeflyingsheep.github.io/posts/openstack/lemote/><link crossorigin=anonymous href=/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as=style><link rel=preload href=/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://freeflyingsheep.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://freeflyingsheep.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://freeflyingsheep.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://freeflyingsheep.github.io/apple-touch-icon.png><link rel=mask-icon href=https://freeflyingsheep.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><meta property="og:title" content="在龙芯上移植 OpenStack"><meta property="og:description" content="整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。"><meta property="og:type" content="article"><meta property="og:url" content="https://freeflyingsheep.github.io/posts/openstack/lemote/"><meta property="og:image" content="https://freeflyingsheep.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-30T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-30T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://freeflyingsheep.github.io/papermod-cover.png"><meta name=twitter:title content="在龙芯上移植 OpenStack"><meta name=twitter:description content="整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://freeflyingsheep.github.io/posts/"},{"@type":"ListItem","position":2,"name":"在龙芯上移植 OpenStack","item":"https://freeflyingsheep.github.io/posts/openstack/lemote/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"在龙芯上移植 OpenStack","name":"在龙芯上移植 OpenStack","description":"整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。\n","keywords":["OpenStack"],"articleBody":"整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。\n工作需求 现在需要移植 OpenStack 核心组件到 lemote Fedora 28 系统上，索性选取了当前最新的稳定分支 Victoria 版本。\n移植所有组件并测试是不现实的，目前只考虑几个核心组件，包括 Nova、Cinder、Neutron、Horizo​​n、Keystone、Glance 和 Placement。\n考虑到 OpenStack 是用 Python 编写的，而 Python 环境和大部分系统工具 lemote Fedora 28 系统上已经存在，而且接口是与 x86 一致的，所以不少组件应该是能直接运行的。龙芯平台的 libvirt 和 QEMU/LVM 是修改过的，因此最有可能需要修改的是 OpenStack Nova 组件的代码（事实证明，确实只需要修改这一个组件）。\n为了方便部署测试，直接选择使用官方的 DevStack 自动部署脚本。\n移植 DevStack 显然，DevStack 不经过修改是无法在龙芯平台上跑通的。修改过的 DevStack 代码见 https://github.com/FreeFlyingSheep/devstack。\n探测版本信息 该部分代码位于 functions-common。\n为了能在多个发行版上运行，DevStack 首先借助 lsb_release 命令探测发行版信息。而 lemote 系统上并没有提供 lsb_release 软件包，为此，通过检查 /proc/version 中的信息，发现是 lemote 系统直接返回，来绕过安装 lsb_release。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  # Make a *best effort* attempt to install lsb_release packages for the # user if not available. Note can't use generic install_package* # because they depend on this! function _ensure_lsb_release { if [[ -x $(command -v lsb_release 2/dev/null) ]]; then return fi # lemote if grep -q \"lemote\" /proc/version; then return fi if [[ -x $(command -v apt-get 2/dev/null) ]]; then sudo apt-get install -y lsb-release elif [[ -x $(command -v zypper 2/dev/null) ]]; then sudo zypper -n install lsb-release elif [[ -x $(command -v dnf 2/dev/null) ]]; then sudo dnf install -y redhat-lsb-core else die $LINENO \"Unable to find or auto-install lsb_release\" fi }   只是绕过安装并没解决问题，还需要手动指定 lemote 系统的发行版系统，为了和其他发行版统一，借助 /etc/os-release 文件来获取相关信息。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  # GetOSVersion # Set the following variables: # - os_RELEASE # - os_CODENAME # - os_VENDOR # - os_PACKAGE function GetOSVersion { # We only support distros that provide a sane lsb_release _ensure_lsb_release if ! grep -q \"lemote\" /proc/version; then os_RELEASE=$(lsb_release -r -s) os_CODENAME=$(lsb_release -c -s) os_VENDOR=$(lsb_release -i -s) else # lemote os_RELEASE=$(grep \"^VERSION_ID=\" /etc/os-release | cut -d '=' -f 2) os_CODENAME=$(grep \"^VERSION=\" /etc/os-release | cut -d '(' -f 2 | cut -d ')' -f 1) os_VENDOR=$(grep \"^NAME=\" /etc/os-release | cut -d '=' -f 2) fi if [[ $os_VENDOR =~ (Debian|Ubuntu|LinuxMint) ]]; then os_PACKAGE=\"deb\" else os_PACKAGE=\"rpm\" fi typeset -xr os_VENDOR typeset -xr os_RELEASE typeset -xr os_PACKAGE typeset -xr os_CODENAME }   同时，为了方便后续判断系统信息，参考脚本提供的 is_suse 函数，加上 is_lemote 函数：\n1 2 3  function is_lemote { is_fedora \u0026\u0026 grep -q \"lemote\" /proc/version }   由于而脚本已经放弃了对 Fedora 28 系统的支持，所以运行时需要加上 FORCE=yes，索性将其添加到 local.conf 中。\n编译 ETCD 脚本会自动根据系统版本信息来从官方下载 ETCD 包，而官方并未提供 MIPS 版本的 ETCD，所以需要手动编译。\nETCD 的编译比较简单，直接从官方仓库克隆，切换到相应版本（为了与脚本统一，选择了 3.3.12 版本），编译并参考其他体系结构的压缩文件打包为 etcd-v3.3.12-linux-mips64.tar.gz，之后在脚本中添加 MIPS 体系结构的信息。\n该部分代码位于 stackrc。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  # etcd3 defaults ETCD_VERSION=${ETCD_VERSION:-v3.3.12} ETCD_SHA256_AMD64=${ETCD_SHA256_AMD64:-\"dc5d82df095dae0a2970e4d870b6929590689dd707ae3d33e7b86da0f7f211b6\"} ETCD_SHA256_ARM64=${ETCD_SHA256_ARM64:-\"170b848ac1a071fe7d495d404a868a2c0090750b2944f8a260ef1c6125b2b4f4\"} ETCD_SHA256_PPC64=${ETCD_SHA256_PPC64:-\"77f807b1b51abbf51e020bb05bdb8ce088cb58260fcd22749ea32eee710463d3\"} # etcd v3.2.x doesn't have anything for s390x ETCD_SHA256_S390X=${ETCD_SHA256_S390X:-\"\"} # etcd v3.2.x doesn't have anything for mips64 ETCD_SHA256_MIPS64=${ETCD_SHA256_MIPS64:-\"5632a3ce5d376701f87887ff5caac5d41a74ec6c1e691a661dc6ce1f1d2effab\"} # Make sure etcd3 downloads the correct architecture if is_arch \"x86_64\"; then ETCD_ARCH=\"amd64\" ETCD_SHA256=${ETCD_SHA256:-$ETCD_SHA256_AMD64} elif is_arch \"aarch64\"; then ETCD_ARCH=\"arm64\" ETCD_SHA256=${ETCD_SHA256:-$ETCD_SHA256_ARM64} elif is_arch \"ppc64le\"; then ETCD_ARCH=\"ppc64le\" ETCD_SHA256=${ETCD_SHA256:-$ETCD_SHA256_PPC64} elif is_arch \"s390x\"; then # An etcd3 binary for s390x is not available on github like it is # for other arches. Only continue if a custom download URL was # provided. if [[ -n \"${ETCD_DOWNLOAD_URL}\" ]]; then ETCD_ARCH=\"s390x\" ETCD_SHA256=${ETCD_SHA256:-$ETCD_SHA256_S390X} else exit_distro_not_supported \"etcd3. No custom ETCD_DOWNLOAD_URL provided.\" fi elif is_arch \"mips64\"; then # An etcd3 binary for mips64 is not available on github like it is # for other arches. Only continue if a custom download URL was # provided. if [[ -n \"${ETCD_DOWNLOAD_URL}\" ]]; then ETCD_ARCH=\"mips64\" ETCD_SHA256=${ETCD_SHA256:-$ETCD_SHA256_MIPS64} else exit_distro_not_supported \"etcd3. No custom ETCD_DOWNLOAD_URL provided.\" fi else exit_distro_not_supported \"invalid hardware type - $ETCD_ARCH\" fi   脚本的下载辅助函数会判断文件是否已经存在，若存在则不下载，因此拷贝 etcd-v3.3.12-linux-mips64.tar.gz 到 files 目录即可，同时在 local.conf 中添加 ETCD_DOWNLOAD_URL=https://fake-url。\n编译好的 ETCD 无法直接运行，因为官方没在 MIPS 上测试过，所以需要添加环境变量 ETCD_UNSUPPORTED_ARCH=mips64le。参考脚本 aarch64 体系结构部分的代码，直接把该环境变量添加到 .service 文件中。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  # start_etcd3() - Starts to run the etcd process function start_etcd3 { ... local unitfile=\"$SYSTEMD_DIR/$ETCD_SYSTEMD_SERVICE\" write_user_unit_file $ETCD_SYSTEMD_SERVICE \"$cmd\" \"\" \"root\" iniset -sudo $unitfile \"Unit\" \"After\" \"network.target\" iniset -sudo $unitfile \"Service\" \"Type\" \"notify\" iniset -sudo $unitfile \"Service\" \"Restart\" \"on-failure\" iniset -sudo $unitfile \"Service\" \"LimitNOFILE\" \"65536\" if is_arch \"aarch64\"; then iniset -sudo $unitfile \"Service\" \"Environment\" \"ETCD_UNSUPPORTED_ARCH=arm64\" fi if is_arch \"mips64\"; then iniset -sudo $unitfile \"Service\" \"Environment\" \"ETCD_UNSUPPORTED_ARCH=mips64le\" fi $SYSTEMCTL daemon-reload $SYSTEMCTL enable $ETCD_SYSTEMD_SERVICE $SYSTEMCTL start $ETCD_SYSTEMD_SERVICE }   修复已知问题 已知 lemote Fedora 28 系统上存在以下问题：\n 缺少 dstat 软件包，且该包并不会在脚本运行中自动安装，使用 dnf 安装即可。 系统自带的 virtualenv 版本过低，使用 pip 升级。 缺少 uwsgi 软件包，dnf 源中不存在该软件包，使用 pip 安装。 系统自带的 wrapt 会阻碍脚本自动升级该软件包，提前把它强制升级。  参考 fixup_fedora 函数，添加 fixup_lemote 函数，并在 fixup_fedora 函数中调用它。该部分代码位于 tools/fixup_stuff.sh。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  function fixup_lemote { if ! is_lemote; then return fi # Install missing tools install_package dstat pip_install -U virtualenv pip_install -U uwsgi pip_install -UI wrapt } function fixup_fedora { ... fixup_lemote }   创建虚拟环境 系统下的 Python3 不认识 python3 -m venv 命令，将其改为 python3 -m virtualenv。该部分代码位于 stackrc。\n1 2 3 4 5 6 7  # Create a virtualenv with this # Use the built-in venv to avoid more dependencies if ! is_lemote; then export VIRTUALENV_CMD=\"python3 -m venv\" else # lemote export VIRTUALENV_CMD=\"python3 -m virtualenv\" fi   设置服务自启 系统重启后，DevStack 无法正常运行，检查日志和服务信息发现 httpd 和 memcached 服务没有设置自启。\n检查脚本发现没有设置服务自启的封装函数（可能是我没找仔细？），参考 start_service 函数定义 _enable_service 函数 （注意已经存在 enable_service 函数了）。该部分代码位于 functions-common。\n1 2 3 4 5 6 7 8 9 10  # Service wrapper to enable services # Note that we already have enable_service above # _enable_service service-name function _enable_service { if [ -x /bin/systemctl ]; then sudo /bin/systemctl enable $1 else sudo service $1 enable fi }   之后，在对应的服务处加上自启。对于 httpd，脚本对 apache 服务又进行了一层封装，添加相应内容。代码位于 lib/apache。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  # lib/apache exports the following functions: # ... # - enable_apache_server # install_apache_wsgi() - Install Apache server and wsgi module function install_apache_wsgi { ... enable_apache_server } # enable_apache_server() - Enabling apache server function enable_apache_server { _enable_service $APACHE_NAME }   对于 memcached，在安装处添加自启即可。代码位于 lib/keystone。\n1 2 3 4 5  # start_keystone() - Start running processes function start_keystone { ... _enable_service memcached }   虚拟化 对于 lemote Fedora 28 系统，必须确保 libvirt-python 和 python3-libvirt 软件包的版本一致，且高于 6.6.0，索性直接在代码中写死。该部分代码位于 lib/nova_plugins/functions-libvirt。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  # Installs required distro-specific libvirt packages. function install_libvirt { if is_ubuntu; then install_package qemu-system libvirt-clients libvirt-daemon-system libvirt-dev if is_arch \"aarch64\"; then install_package qemu-efi fi # uninstall in case the libvirt version changed pip_uninstall libvirt-python pip_install_gr libvirt-python #pip_install_gr  elif is_fedora || is_suse; then # Optionally enable the virt-preview repo when on Fedora if [[ $DISTRO =~ f[0-9][0-9] ]] \u0026\u0026 [[ ${ENABLE_FEDORA_VIRT_PREVIEW_REPO} == \"True\" ]]; then # https://copr.fedorainfracloud.org/coprs/g/virtmaint-sig/virt-preview/ sudo dnf copr enable -y @virtmaint-sig/virt-preview fi # Note that in CentOS/RHEL this needs to come from the RDO # repositories (qemu-kvm-ev ... which provides this package) # as the base system version is too old. We should have # pre-installed these install_package qemu-kvm install_package libvirt libvirt-devel if is_arch \"aarch64\"; then install_package edk2.git-aarch64 fi if ! is_lemote; then pip_uninstall libvirt-python pip_install_gr libvirt-python else # lemote install_package libvirt-6.6.0 install_package python3-libvirt-6.6.0 fi fi if [[ $DEBUG_LIBVIRT_COREDUMPS == True ]]; then _enable_coredump fi }   同时，系统只支持 custom 模式，模拟 Loongson-3A4000（见修改 CPU 模式部分）。默认的脚本只提供 none、host-model 和 host-passthrough 模式，参考 aarch64 体系结构，添加相关代码。该部分代码位于 lib/nova_plugins/hypervisor-libvirt。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  # configure_nova_hypervisor - Set config files, create data dirs, etc function configure_nova_hypervisor { ... # arm64-specific configuration if is_arch \"aarch64\"; then iniset $NOVA_CONF libvirt cpu_mode \"host-passthrough\" fi # mips64-specific configuration if is_arch \"mips64\"; then iniset $NOVA_CONF libvirt cpu_mode \"custom\" iniset $NOVA_CONF libvirt cpu_models \"Loongson-3A4000\" fi ... }   移植 Nova 由于龙芯平台的 libvirt 和 QEMU/KVM 的实现还不完全，nova-compute 不经过修改无法在龙芯平台上正常运行。修改过的 Nova 代码见 https://github.com/FreeFlyingSheep/Nova。\n修改 CPU 模式 在未修改 CPU 模式时，运行 DevStack，尝试创建虚拟机时报错，查看日志显示 libvirt 内部错误，未知 CPU 类型 qemu64。\n查看 nova-compute 配置文件发现 DevStack 默认 CPU 模式设置为 none，尝试改为 host-model 和 host-passthrough，依然报 libvirt 内部错误，但错误内容变为不支持这两种模式。\n查看 libvirt 源码，定位报错的位置，发现龙芯平台上的 libvirt 实现并不完全，去把这些接口都实现了显然不现实。考虑到龙芯平台通过修改过的 virt-manager 是能正常创建虚拟机的，就想到比较龙芯平台的 virt-manager 创建虚拟机的参数和 nova-compute 默认创建的参数（主要比较生成的给 libvirt 使用的 xml 文件）。\n对比发现，virt-manager 生成的 xml 文件中，使用的是 custom 模式，模拟 Loongson-3A4000。修改 nova-compute 的配置文件，设置这两个参数，错误变为了没有使用 PCIe。\n修改 PCIe 配置 查看 Nova 源码，直接强制检查 PCIe 的函数对于 mips64el 架构返回 True。该部分代码位于 virt/libvirt/driver.py。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  def _guest_needs_pcie(self, guest, caps): \"\"\"Check for prerequisites for adding PCIe root port controllers \"\"\" ... if caps.host.cpu.arch == fields.Architecture.MIPS64EL: return True if not CONF.libvirt.num_pcie_ports: return False if (caps.host.cpu.arch == fields.Architecture.AARCH64 and guest.os_mach_type.startswith('virt')): return True if (caps.host.cpu.arch == fields.Architecture.X86_64 and guest.os_mach_type is not None and 'q35' in guest.os_mach_type): return True return False   重启 Nova 服务，发现虚拟机创建成功，但无法运行，错误变为了没法加载 BIOS。\n添加其他参数 继续比较 xml 文件，发现 virt-manager 生成的 xml 会指定 BIOS 文件和其他相关参数，查看 Nova 源码，将这部分内容写到对应位置。代码位于 virt/libvirt/driver.py。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  def _configure_guest_by_virt_type(self, guest, virt_type, caps, instance, image_meta, flavor, root_device_name, sev_enabled): if virt_type == \"xen\": ... elif virt_type in (\"kvm\", \"qemu\"): if caps.host.cpu.arch in (fields.Architecture.I686, fields.Architecture.X86_64): guest.sysinfo = self._get_guest_config_sysinfo(instance) guest.os_smbios = vconfig.LibvirtConfigGuestSMBIOS() hw_firmware_type = image_meta.properties.get('hw_firmware_type') ... if image_meta.properties.get('hw_boot_menu') is None: guest.os_bootmenu = strutils.bool_from_string( flavor.extra_specs.get('hw:boot_menu', 'no')) else: guest.os_bootmenu = image_meta.properties.hw_boot_menu if caps.host.cpu.arch == fields.Architecture.MIPS64EL: guest.os_loader = \"/usr/share/qemu/bios_loongson3.bin\" guest.os_loader_type = \"rom\" guest.os_mach_type = \"loongson3-virt\" elif virt_type == \"lxc\": ...   重启 Nova 服务，发现虚拟机成功创建，并运行，但控制台界面卡在了加载内核。\n修改显示模式（后来又改回去了） 查看日志，发现并没有任何报错。思考了一会，推测是内核其实已经成功启动，但没正常显示。\n继续对比 xml 文件，发现 nova-compute 默认使用的显卡设备模型为 cirrus，而 virt-manager 使用的显卡设备模型为 qxl。在 virt-manager 的选项中，没有找到 cirrus 显卡设备模型，怀疑不支持。\n于是修改 nova-compute 相关代码，使它在 mips64 架构下默认使用 qxl。该部分代码位于 virt/libvirt/driver.py。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  def _add_video_driver(self, guest, image_meta, flavor): ... if guest.os_type == fields.VMMode.XEN: video.type = 'xen' elif CONF.libvirt.virt_type == 'parallels': video.type = 'vga' elif guestarch in (fields.Architecture.PPC, fields.Architecture.PPC64, fields.Architecture.PPC64LE): # NOTE(ldbragst): PowerKVM doesn't support 'cirrus' be default # so use 'vga' instead when running on Power hardware. video.type = 'vga' elif guestarch == fields.Architecture.AARCH64: # NOTE(kevinz): Only virtio device type is supported by AARCH64 # so use 'virtio' instead when running on AArch64 hardware. video.type = 'virtio' elif (CONF.spice.enabled) or (guestarch == fields.Architecture.MIPS64): video.type = 'qxl' if image_meta.properties.get('hw_video_model'): video.type = image_meta.properties.hw_video_model if not self._video_model_supported(video.type): raise exception.InvalidVideoMode(model=video.type) ...   重启 Nova 服务，这次控制台界面显示出了开机动画，但发现键盘没有反应。\n添加键盘设备 鼠标能动但键盘没有反应，推测使没添加键盘，查看 xml 发现果然如此。\n在 Nova 中添加键盘。该部分代码位于 virt/libvirt/driver.py。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  def _get_guest_config(self, instance, network_info, image_meta, disk_info, rescue=None, block_device_info=None, context=None, mdevs=None, accel_info=None): \"\"\"Get config data for parameters. :param rescue: optional dictionary that should contain the key 'ramdisk_id' if a ramdisk is needed for the rescue image and 'kernel_id' if a kernel is needed for the rescue image. :param mdevs: optional list of mediated devices to assign to the guest. :param accel_info: optional list of accelerator requests (ARQs) \"\"\" ... self._guest_add_spice_channel(guest) if self._guest_add_video_device(guest): self._add_video_driver(guest, image_meta, flavor) # We want video == we want graphical console. Some architectures # do not have input devices attached in default configuration. # Let then add USB Host controller and USB keyboard. # x86(-64) and ppc64 have usb host controller and keyboard # s390x does not support USB if caps.host.cpu.arch in (fields.Architecture.AARCH64, fields.Architecture.MIPS64EL): self._guest_add_usb_host_keyboard(guest) # Some features are only supported 'qemu' and 'kvm' hypervisor if virt_type in ('qemu', 'kvm'): self._set_qemu_guest_agent(guest, flavor, instance, image_meta) self._add_rng_device(guest, flavor, image_meta) self._add_vtpm_device(guest, flavor, instance, image_meta) ...   重启 Nova 服务，键盘能正常使用了，但鼠标能移动却无法点击。\n改用 spice 听取同事建议后，索性改用 spice 协议，而不是 vnc 协议。这样可以移除 Nova 中显示模式部分的修改，鼠标也能正常使用了。\n对于 DevStack，只需要修改配置文件 local.conf 即可，添加两行内容：\n1 2  enable_service n-spice n-sproxy disable_service n-novnc n-xvnc   其他问题 创建虚拟机的过程中，一旦涉及 Cinder 服务，就会报错，因此暂时使用了 Nova 自带的创建卷功能。\n成功把 Nova 跑通后，开始解决 Cinder 无法映射块设备的问题。查看日志报错信息，发现是创建 LVM 卷的时候出错了。\n根据网上资料手动创建 LVM 卷，复现了报错信息，只要是使用 thin 模式，创建卷就会报错，这应该是系统中相关的软件包存在问题，暂时将 cinder 的 LVM 模式更换为 default，绕过了这个问题，成功创建了卷。\n还有一些问题，但暂时没想到解决办法。比如内核没有输出日志信息，检查 xml 确定已经重定向到了 console.log，内核启动也添加了相关参数。还有从 ISO 文件创建虚拟机时会报找不到设备等问题（由于系统的 QEMU/KVM 只支持龙芯的镜像，所以必须使用提前准备好的镜像）。\n对于 DevStack，最终的 local.conf 配置如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  [[local|localrc]] FORCE=yes ADMIN_PASSWORD=123456 DATABASE_PASSWORD=$ADMIN_PASSWORD RABBIT_PASSWORD=$ADMIN_PASSWORD SERVICE_PASSWORD=$ADMIN_PASSWORD GIT_BASE=https://github.com NOVA_REPO=https://github.com/FreeFlyingSheep/nova.git ETCD_DOWNLOAD_URL=https://fake-url DOWNLOAD_DEFAULT_IMAGES=False IMAGE_URLS=https://fake-url/fedora28.qcow2 CINDER_LVM_TYPE=default enable_service n-spice n-sproxy disable_service n-novnc n-xvnc   至此，OpenStack 的移植初步完成了，到了勉强能用的地步。因为暂时没有后续的需求，所以先到此为止了。\n","wordCount":"1932","inLanguage":"zh-cn","datePublished":"2020-11-30T00:00:00Z","dateModified":"2020-11-30T00:00:00Z","author":{"@type":"Person","name":"FreeFlyingSheep"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://freeflyingsheep.github.io/posts/openstack/lemote/"},"publisher":{"@type":"Organization","name":"FreeFlyingSheep 的小站","logo":{"@type":"ImageObject","url":"https://freeflyingsheep.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://freeflyingsheep.github.io/ accesskey=h title="FreeFlyingSheep 的小站 (Alt + H)">FreeFlyingSheep 的小站</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://freeflyingsheep.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://freeflyingsheep.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://freeflyingsheep.github.io/series title=Series><span>Series</span></a></li><li><a href=https://freeflyingsheep.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://freeflyingsheep.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://freeflyingsheep.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://freeflyingsheep.github.io/posts/>Posts</a></div><h1 class=post-title>在龙芯上移植 OpenStack</h1><div class=post-meta>November 30, 2020&nbsp;·&nbsp;10 min&nbsp;·&nbsp;FreeFlyingSheep</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#%e5%b7%a5%e4%bd%9c%e9%9c%80%e6%b1%82 aria-label=工作需求>工作需求</a></li><li><a href=#%e7%a7%bb%e6%a4%8d-devstack aria-label="移植 DevStack">移植 DevStack</a><ul><li><a href=#%e6%8e%a2%e6%b5%8b%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af aria-label=探测版本信息>探测版本信息</a></li><li><a href=#%e7%bc%96%e8%af%91-etcd aria-label="编译 ETCD">编译 ETCD</a></li><li><a href=#%e4%bf%ae%e5%a4%8d%e5%b7%b2%e7%9f%a5%e9%97%ae%e9%a2%98 aria-label=修复已知问题>修复已知问题</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83 aria-label=创建虚拟环境>创建虚拟环境</a></li><li><a href=#%e8%ae%be%e7%bd%ae%e6%9c%8d%e5%8a%a1%e8%87%aa%e5%90%af aria-label=设置服务自启>设置服务自启</a></li><li><a href=#%e8%99%9a%e6%8b%9f%e5%8c%96 aria-label=虚拟化>虚拟化</a></li></ul></li><li><a href=#%e7%a7%bb%e6%a4%8d-nova aria-label="移植 Nova">移植 Nova</a><ul><li><a href=#%e4%bf%ae%e6%94%b9-cpu-%e6%a8%a1%e5%bc%8f aria-label="修改 CPU 模式">修改 CPU 模式</a></li><li><a href=#%e4%bf%ae%e6%94%b9-pcie-%e9%85%8d%e7%bd%ae aria-label="修改 PCIe 配置">修改 PCIe 配置</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e5%85%b6%e4%bb%96%e5%8f%82%e6%95%b0 aria-label=添加其他参数>添加其他参数</a></li><li><a href=#%e4%bf%ae%e6%94%b9%e6%98%be%e7%a4%ba%e6%a8%a1%e5%bc%8f%e5%90%8e%e6%9d%a5%e5%8f%88%e6%94%b9%e5%9b%9e%e5%8e%bb%e4%ba%86 aria-label=修改显示模式（后来又改回去了）>修改显示模式（后来又改回去了）</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e9%94%ae%e7%9b%98%e8%ae%be%e5%a4%87 aria-label=添加键盘设备>添加键盘设备</a></li><li><a href=#%e6%94%b9%e7%94%a8-spice aria-label="改用 spice">改用 spice</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98 aria-label=其他问题>其他问题</a></li></ul></div></details></div><div class=post-content><p>整理工作中移植 OpenStack Victoria 版本核心组件到龙芯 lemote Fedora 28 系统上的过程。</p><h2 id=工作需求>工作需求<a hidden class=anchor aria-hidden=true href=#工作需求>#</a></h2><p>现在需要移植 OpenStack 核心组件到 lemote Fedora 28 系统上，索性选取了当前最新的稳定分支 Victoria 版本。</p><p>移植所有组件并测试是不现实的，目前只考虑几个核心组件，包括 Nova、Cinder、Neutron、Horizo​​n、Keystone、Glance 和 Placement。</p><p>考虑到 OpenStack 是用 Python 编写的，而 Python 环境和大部分系统工具 lemote Fedora 28 系统上已经存在，而且接口是与 x86 一致的，所以不少组件应该是能直接运行的。龙芯平台的 libvirt 和 QEMU/LVM 是修改过的，因此最有可能需要修改的是 OpenStack Nova 组件的代码（事实证明，确实只需要修改这一个组件）。</p><p>为了方便部署测试，直接选择使用官方的 <a href=https://opendev.org/openstack/devstack>DevStack</a> 自动部署脚本。</p><h2 id=移植-devstack>移植 DevStack<a hidden class=anchor aria-hidden=true href=#移植-devstack>#</a></h2><p>显然，DevStack 不经过修改是无法在龙芯平台上跑通的。修改过的 DevStack 代码见 <a href=https://github.com/FreeFlyingSheep/devstack>https://github.com/FreeFlyingSheep/devstack</a>。</p><h3 id=探测版本信息>探测版本信息<a hidden class=anchor aria-hidden=true href=#探测版本信息>#</a></h3><p>该部分代码位于 <code>functions-common</code>。</p><p>为了能在多个发行版上运行，DevStack 首先借助 <code>lsb_release</code> 命令探测发行版信息。而 lemote 系统上并没有提供 <code>lsb_release</code> 软件包，为此，通过检查 <code>/proc/version</code> 中的信息，发现是 lemote 系统直接返回，来绕过安装 <code>lsb_release</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Make a *best effort* attempt to install lsb_release packages for the</span>
<span style=color:#75715e># user if not available.  Note can&#39;t use generic install_package*</span>
<span style=color:#75715e># because they depend on this!</span>
<span style=color:#66d9ef>function</span> _ensure_lsb_release <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -x <span style=color:#66d9ef>$(</span>command -v lsb_release 2&gt;/dev/null<span style=color:#66d9ef>)</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#75715e># lemote</span>
    <span style=color:#66d9ef>if</span> grep -q <span style=color:#e6db74>&#34;lemote&#34;</span> /proc/version; <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -x <span style=color:#66d9ef>$(</span>command -v apt-get 2&gt;/dev/null<span style=color:#66d9ef>)</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        sudo apt-get install -y lsb-release
    <span style=color:#66d9ef>elif</span> <span style=color:#f92672>[[</span> -x <span style=color:#66d9ef>$(</span>command -v zypper 2&gt;/dev/null<span style=color:#66d9ef>)</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        sudo zypper -n install lsb-release
    <span style=color:#66d9ef>elif</span> <span style=color:#f92672>[[</span> -x <span style=color:#66d9ef>$(</span>command -v dnf 2&gt;/dev/null<span style=color:#66d9ef>)</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        sudo dnf install -y redhat-lsb-core
    <span style=color:#66d9ef>else</span>
        die $LINENO <span style=color:#e6db74>&#34;Unable to find or auto-install lsb_release&#34;</span>
    <span style=color:#66d9ef>fi</span>
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>只是绕过安装并没解决问题，还需要手动指定 lemote 系统的发行版系统，为了和其他发行版统一，借助 <code>/etc/os-release</code> 文件来获取相关信息。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># GetOSVersion</span>
<span style=color:#75715e>#  Set the following variables:</span>
<span style=color:#75715e>#  - os_RELEASE</span>
<span style=color:#75715e>#  - os_CODENAME</span>
<span style=color:#75715e>#  - os_VENDOR</span>
<span style=color:#75715e>#  - os_PACKAGE</span>
<span style=color:#66d9ef>function</span> GetOSVersion <span style=color:#f92672>{</span>
    <span style=color:#75715e># We only support distros that provide a sane lsb_release</span>
    _ensure_lsb_release

    <span style=color:#66d9ef>if</span> ! grep -q <span style=color:#e6db74>&#34;lemote&#34;</span> /proc/version; <span style=color:#66d9ef>then</span>
        os_RELEASE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>lsb_release -r -s<span style=color:#66d9ef>)</span>
        os_CODENAME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>lsb_release -c -s<span style=color:#66d9ef>)</span>
        os_VENDOR<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>lsb_release -i -s<span style=color:#66d9ef>)</span>
    <span style=color:#66d9ef>else</span> <span style=color:#75715e># lemote</span>
        os_RELEASE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep <span style=color:#e6db74>&#34;^VERSION_ID=&#34;</span> /etc/os-release | cut -d <span style=color:#e6db74>&#39;=&#39;</span> -f 2<span style=color:#66d9ef>)</span>
        os_CODENAME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep <span style=color:#e6db74>&#34;^VERSION=&#34;</span> /etc/os-release | cut -d <span style=color:#e6db74>&#39;(&#39;</span> -f <span style=color:#ae81ff>2</span> | cut -d <span style=color:#e6db74>&#39;)&#39;</span> -f 1<span style=color:#66d9ef>)</span>
        os_VENDOR<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>grep <span style=color:#e6db74>&#34;^NAME=&#34;</span> /etc/os-release | cut -d <span style=color:#e6db74>&#39;=&#39;</span> -f 2<span style=color:#66d9ef>)</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $os_VENDOR <span style=color:#f92672>=</span>~ <span style=color:#f92672>(</span>Debian|Ubuntu|LinuxMint<span style=color:#f92672>)</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        os_PACKAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;deb&#34;</span>
    <span style=color:#66d9ef>else</span>
        os_PACKAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpm&#34;</span>
    <span style=color:#66d9ef>fi</span>

    typeset -xr os_VENDOR
    typeset -xr os_RELEASE
    typeset -xr os_PACKAGE
    typeset -xr os_CODENAME
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>同时，为了方便后续判断系统信息，参考脚本提供的 <code>is_suse</code> 函数，加上 <code>is_lemote</code> 函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>function</span> is_lemote <span style=color:#f92672>{</span>
    is_fedora <span style=color:#f92672>&amp;&amp;</span> grep -q <span style=color:#e6db74>&#34;lemote&#34;</span> /proc/version
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>由于而脚本已经放弃了对 Fedora 28 系统的支持，所以运行时需要加上 <code>FORCE=yes</code>，索性将其添加到 <code>local.conf</code> 中。</p><h3 id=编译-etcd>编译 ETCD<a hidden class=anchor aria-hidden=true href=#编译-etcd>#</a></h3><p>脚本会自动根据系统版本信息来从官方下载 ETCD 包，而官方并未提供 MIPS 版本的 ETCD，所以需要手动编译。</p><p>ETCD 的编译比较简单，直接从<a href=https://github.com/etcd-io/etcd>官方仓库</a>克隆，切换到相应版本（为了与脚本统一，选择了 3.3.12 版本），编译并参考其他体系结构的压缩文件打包为 <code>etcd-v3.3.12-linux-mips64.tar.gz</code>，之后在脚本中添加 MIPS 体系结构的信息。</p><p>该部分代码位于 <code>stackrc</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># etcd3 defaults</span>
ETCD_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_VERSION<span style=color:#66d9ef>:-</span>v3.3.12<span style=color:#e6db74>}</span>
ETCD_SHA256_AMD64<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256_AMD64<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;dc5d82df095dae0a2970e4d870b6929590689dd707ae3d33e7b86da0f7f211b6&#34;</span><span style=color:#e6db74>}</span>
ETCD_SHA256_ARM64<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256_ARM64<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;170b848ac1a071fe7d495d404a868a2c0090750b2944f8a260ef1c6125b2b4f4&#34;</span><span style=color:#e6db74>}</span>
ETCD_SHA256_PPC64<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256_PPC64<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;77f807b1b51abbf51e020bb05bdb8ce088cb58260fcd22749ea32eee710463d3&#34;</span><span style=color:#e6db74>}</span>
<span style=color:#75715e># etcd v3.2.x doesn&#39;t have anything for s390x</span>
ETCD_SHA256_S390X<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256_S390X<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>}</span>
<span style=color:#75715e># etcd v3.2.x doesn&#39;t have anything for mips64</span>
ETCD_SHA256_MIPS64<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256_MIPS64<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;5632a3ce5d376701f87887ff5caac5d41a74ec6c1e691a661dc6ce1f1d2effab&#34;</span><span style=color:#e6db74>}</span>
<span style=color:#75715e># Make sure etcd3 downloads the correct architecture</span>
<span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;x86_64&#34;</span>; <span style=color:#66d9ef>then</span>
    ETCD_ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;amd64&#34;</span>
    ETCD_SHA256<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256<span style=color:#66d9ef>:-</span>$ETCD_SHA256_AMD64<span style=color:#e6db74>}</span>
<span style=color:#66d9ef>elif</span> is_arch <span style=color:#e6db74>&#34;aarch64&#34;</span>; <span style=color:#66d9ef>then</span>
    ETCD_ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;arm64&#34;</span>
    ETCD_SHA256<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256<span style=color:#66d9ef>:-</span>$ETCD_SHA256_ARM64<span style=color:#e6db74>}</span>
<span style=color:#66d9ef>elif</span> is_arch <span style=color:#e6db74>&#34;ppc64le&#34;</span>; <span style=color:#66d9ef>then</span>
    ETCD_ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ppc64le&#34;</span>
    ETCD_SHA256<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256<span style=color:#66d9ef>:-</span>$ETCD_SHA256_PPC64<span style=color:#e6db74>}</span>
<span style=color:#66d9ef>elif</span> is_arch <span style=color:#e6db74>&#34;s390x&#34;</span>; <span style=color:#66d9ef>then</span>
    <span style=color:#75715e># An etcd3 binary for s390x is not available on github like it is</span>
    <span style=color:#75715e># for other arches. Only continue if a custom download URL was</span>
    <span style=color:#75715e># provided.</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ETCD_DOWNLOAD_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        ETCD_ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;s390x&#34;</span>
        ETCD_SHA256<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256<span style=color:#66d9ef>:-</span>$ETCD_SHA256_S390X<span style=color:#e6db74>}</span>
    <span style=color:#66d9ef>else</span>
        exit_distro_not_supported <span style=color:#e6db74>&#34;etcd3. No custom ETCD_DOWNLOAD_URL provided.&#34;</span>
    <span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>elif</span> is_arch <span style=color:#e6db74>&#34;mips64&#34;</span>; <span style=color:#66d9ef>then</span>
    <span style=color:#75715e># An etcd3 binary for mips64 is not available on github like it is</span>
    <span style=color:#75715e># for other arches. Only continue if a custom download URL was</span>
    <span style=color:#75715e># provided.</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>ETCD_DOWNLOAD_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        ETCD_ARCH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mips64&#34;</span>
        ETCD_SHA256<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ETCD_SHA256<span style=color:#66d9ef>:-</span>$ETCD_SHA256_MIPS64<span style=color:#e6db74>}</span>
    <span style=color:#66d9ef>else</span>
        exit_distro_not_supported <span style=color:#e6db74>&#34;etcd3. No custom ETCD_DOWNLOAD_URL provided.&#34;</span>
    <span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>else</span>
    exit_distro_not_supported <span style=color:#e6db74>&#34;invalid hardware type - </span>$ETCD_ARCH<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>
</code></pre></td></tr></table></div></div><p>脚本的下载辅助函数会判断文件是否已经存在，若存在则不下载，因此拷贝 <code>etcd-v3.3.12-linux-mips64.tar.gz</code> 到 <code>files</code> 目录即可，同时在 <code>local.conf</code> 中添加 <code>ETCD_DOWNLOAD_URL=https://fake-url</code>。</p><p>编译好的 ETCD 无法直接运行，因为官方没在 MIPS 上测试过，所以需要添加环境变量 <code>ETCD_UNSUPPORTED_ARCH=mips64le</code>。参考脚本 aarch64 体系结构部分的代码，直接把该环境变量添加到 <code>.service</code> 文件中。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># start_etcd3() - Starts to run the etcd process</span>
<span style=color:#66d9ef>function</span> start_etcd3 <span style=color:#f92672>{</span>
    ...
    local unitfile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$SYSTEMD_DIR<span style=color:#e6db74>/</span>$ETCD_SYSTEMD_SERVICE<span style=color:#e6db74>&#34;</span>
    write_user_unit_file $ETCD_SYSTEMD_SERVICE <span style=color:#e6db74>&#34;</span>$cmd<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#e6db74>&#34;root&#34;</span>

    iniset -sudo $unitfile <span style=color:#e6db74>&#34;Unit&#34;</span> <span style=color:#e6db74>&#34;After&#34;</span> <span style=color:#e6db74>&#34;network.target&#34;</span>
    iniset -sudo $unitfile <span style=color:#e6db74>&#34;Service&#34;</span> <span style=color:#e6db74>&#34;Type&#34;</span> <span style=color:#e6db74>&#34;notify&#34;</span>
    iniset -sudo $unitfile <span style=color:#e6db74>&#34;Service&#34;</span> <span style=color:#e6db74>&#34;Restart&#34;</span> <span style=color:#e6db74>&#34;on-failure&#34;</span>
    iniset -sudo $unitfile <span style=color:#e6db74>&#34;Service&#34;</span> <span style=color:#e6db74>&#34;LimitNOFILE&#34;</span> <span style=color:#e6db74>&#34;65536&#34;</span>
    <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;aarch64&#34;</span>; <span style=color:#66d9ef>then</span>
        iniset -sudo $unitfile <span style=color:#e6db74>&#34;Service&#34;</span> <span style=color:#e6db74>&#34;Environment&#34;</span> <span style=color:#e6db74>&#34;ETCD_UNSUPPORTED_ARCH=arm64&#34;</span>
    <span style=color:#66d9ef>fi</span>
    <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;mips64&#34;</span>; <span style=color:#66d9ef>then</span>
        iniset -sudo $unitfile <span style=color:#e6db74>&#34;Service&#34;</span> <span style=color:#e6db74>&#34;Environment&#34;</span> <span style=color:#e6db74>&#34;ETCD_UNSUPPORTED_ARCH=mips64le&#34;</span>
    <span style=color:#66d9ef>fi</span>

    $SYSTEMCTL daemon-reload
    $SYSTEMCTL enable $ETCD_SYSTEMD_SERVICE
    $SYSTEMCTL start $ETCD_SYSTEMD_SERVICE
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><h3 id=修复已知问题>修复已知问题<a hidden class=anchor aria-hidden=true href=#修复已知问题>#</a></h3><p>已知 lemote Fedora 28 系统上存在以下问题：</p><ul><li>缺少 <code>dstat</code> 软件包，且该包并不会在脚本运行中自动安装，使用 <code>dnf</code> 安装即可。</li><li>系统自带的 <code>virtualenv</code> 版本过低，使用 <code>pip</code> 升级。</li><li>缺少 <code>uwsgi</code> 软件包，<code>dnf</code> 源中不存在该软件包，使用 <code>pip</code> 安装。</li><li>系统自带的 <code>wrapt</code> 会阻碍脚本自动升级该软件包，提前把它强制升级。</li></ul><p>参考 <code>fixup_fedora</code> 函数，添加 <code>fixup_lemote</code> 函数，并在 <code>fixup_fedora</code> 函数中调用它。该部分代码位于 <code>tools/fixup_stuff.sh</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>function</span> fixup_lemote <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> ! is_lemote; <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>return</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#75715e># Install missing tools</span>
    install_package dstat
    pip_install -U virtualenv
    pip_install -U uwsgi
    pip_install -UI wrapt
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>function</span> fixup_fedora <span style=color:#f92672>{</span>
    ...
    fixup_lemote
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><h3 id=创建虚拟环境>创建虚拟环境<a hidden class=anchor aria-hidden=true href=#创建虚拟环境>#</a></h3><p>系统下的 Python3 不认识 <code>python3 -m venv</code> 命令，将其改为 <code>python3 -m virtualenv</code>。该部分代码位于 <code>stackrc</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Create a virtualenv with this</span>
<span style=color:#75715e># Use the built-in venv to avoid more dependencies</span>
<span style=color:#66d9ef>if</span> ! is_lemote; <span style=color:#66d9ef>then</span>
    export VIRTUALENV_CMD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;python3 -m venv&#34;</span>
<span style=color:#66d9ef>else</span> <span style=color:#75715e># lemote</span>
    export VIRTUALENV_CMD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;python3 -m virtualenv&#34;</span>
<span style=color:#66d9ef>fi</span>
</code></pre></td></tr></table></div></div><h3 id=设置服务自启>设置服务自启<a hidden class=anchor aria-hidden=true href=#设置服务自启>#</a></h3><p>系统重启后，DevStack 无法正常运行，检查日志和服务信息发现 <code>httpd</code> 和 <code>memcached</code> 服务没有设置自启。</p><p>检查脚本发现没有设置服务自启的封装函数（可能是我没找仔细？），参考 <code>start_service</code> 函数定义 <code>_enable_service</code> 函数 （注意已经存在 <code>enable_service</code> 函数了）。该部分代码位于 <code>functions-common</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Service wrapper to enable services</span>
<span style=color:#75715e># Note that we already have enable_service above</span>
<span style=color:#75715e># _enable_service service-name</span>
<span style=color:#66d9ef>function</span> _enable_service <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x /bin/systemctl <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
        sudo /bin/systemctl enable $1
    <span style=color:#66d9ef>else</span>
        sudo service $1 enable
    <span style=color:#66d9ef>fi</span>
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>之后，在对应的服务处加上自启。对于 <code>httpd</code>，脚本对 apache 服务又进行了一层封装，添加相应内容。代码位于 <code>lib/apache</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># lib/apache exports the following functions:</span>
<span style=color:#75715e># ...</span>
<span style=color:#75715e># - enable_apache_server</span>

<span style=color:#75715e># install_apache_wsgi() - Install Apache server and wsgi module</span>
<span style=color:#66d9ef>function</span> install_apache_wsgi <span style=color:#f92672>{</span>
    ...
    enable_apache_server
<span style=color:#f92672>}</span>

<span style=color:#75715e># enable_apache_server() - Enabling apache server</span>
<span style=color:#66d9ef>function</span> enable_apache_server <span style=color:#f92672>{</span>
    _enable_service $APACHE_NAME
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>对于 <code>memcached</code>，在安装处添加自启即可。代码位于 <code>lib/keystone</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># start_keystone() - Start running processes</span>
<span style=color:#66d9ef>function</span> start_keystone <span style=color:#f92672>{</span>
    ...
    _enable_service memcached
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><h3 id=虚拟化>虚拟化<a hidden class=anchor aria-hidden=true href=#虚拟化>#</a></h3><p>对于 lemote Fedora 28 系统，必须确保 <code>libvirt-python</code> 和 <code>python3-libvirt</code> 软件包的版本一致，且高于 6.6.0，索性直接在代码中写死。该部分代码位于 <code>lib/nova_plugins/functions-libvirt</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Installs required distro-specific libvirt packages.</span>
<span style=color:#66d9ef>function</span> install_libvirt <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>if</span> is_ubuntu; <span style=color:#66d9ef>then</span>
        install_package qemu-system libvirt-clients libvirt-daemon-system libvirt-dev
        <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;aarch64&#34;</span>; <span style=color:#66d9ef>then</span>
            install_package qemu-efi
        <span style=color:#66d9ef>fi</span>
        <span style=color:#75715e># uninstall in case the libvirt version changed</span>
        pip_uninstall libvirt-python
        pip_install_gr libvirt-python
        <span style=color:#75715e>#pip_install_gr &lt;there-si-no-guestfs-in-pypi&gt;</span>
    <span style=color:#66d9ef>elif</span> is_fedora <span style=color:#f92672>||</span> is_suse; <span style=color:#66d9ef>then</span>

        <span style=color:#75715e># Optionally enable the virt-preview repo when on Fedora</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $DISTRO <span style=color:#f92672>=</span>~ f<span style=color:#f92672>[</span>0-9<span style=color:#f92672>][</span>0-9<span style=color:#f92672>]</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[[</span> <span style=color:#e6db74>${</span>ENABLE_FEDORA_VIRT_PREVIEW_REPO<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;True&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
            <span style=color:#75715e># https://copr.fedorainfracloud.org/coprs/g/virtmaint-sig/virt-preview/</span>
            sudo dnf copr enable -y @virtmaint-sig/virt-preview
        <span style=color:#66d9ef>fi</span>

        <span style=color:#75715e># Note that in CentOS/RHEL this needs to come from the RDO</span>
        <span style=color:#75715e># repositories (qemu-kvm-ev ... which provides this package)</span>
        <span style=color:#75715e># as the base system version is too old.  We should have</span>
        <span style=color:#75715e># pre-installed these</span>
        install_package qemu-kvm

        install_package libvirt libvirt-devel
        <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;aarch64&#34;</span>; <span style=color:#66d9ef>then</span>
            install_package edk2.git-aarch64
        <span style=color:#66d9ef>fi</span>

        <span style=color:#66d9ef>if</span> ! is_lemote; <span style=color:#66d9ef>then</span>
            pip_uninstall libvirt-python
            pip_install_gr libvirt-python
        <span style=color:#66d9ef>else</span> <span style=color:#75715e># lemote</span>
            install_package libvirt-6.6.0
            install_package python3-libvirt-6.6.0
        <span style=color:#66d9ef>fi</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $DEBUG_LIBVIRT_COREDUMPS <span style=color:#f92672>==</span> True <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
        _enable_coredump
    <span style=color:#66d9ef>fi</span>
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><p>同时，系统只支持 <code>custom</code> 模式，模拟 <code>Loongson-3A4000</code>（见<a href=#%E4%BF%AE%E6%94%B9-cpu-%E6%A8%A1%E5%BC%8F>修改 CPU 模式</a>部分）。默认的脚本只提供 <code>none</code>、<code>host-model</code> 和 <code>host-passthrough</code> 模式，参考 aarch64 体系结构，添加相关代码。该部分代码位于 <code>lib/nova_plugins/hypervisor-libvirt</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># configure_nova_hypervisor - Set config files, create data dirs, etc</span>
<span style=color:#66d9ef>function</span> configure_nova_hypervisor <span style=color:#f92672>{</span>
    ...
    <span style=color:#75715e># arm64-specific configuration</span>
    <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;aarch64&#34;</span>; <span style=color:#66d9ef>then</span>
        iniset $NOVA_CONF libvirt cpu_mode <span style=color:#e6db74>&#34;host-passthrough&#34;</span>
    <span style=color:#66d9ef>fi</span>

    <span style=color:#75715e># mips64-specific configuration</span>
    <span style=color:#66d9ef>if</span> is_arch <span style=color:#e6db74>&#34;mips64&#34;</span>; <span style=color:#66d9ef>then</span>
        iniset $NOVA_CONF libvirt cpu_mode <span style=color:#e6db74>&#34;custom&#34;</span>
        iniset $NOVA_CONF libvirt cpu_models <span style=color:#e6db74>&#34;Loongson-3A4000&#34;</span>
    <span style=color:#66d9ef>fi</span>
    ...
<span style=color:#f92672>}</span>
</code></pre></td></tr></table></div></div><h2 id=移植-nova>移植 Nova<a hidden class=anchor aria-hidden=true href=#移植-nova>#</a></h2><p>由于龙芯平台的 libvirt 和 QEMU/KVM 的实现还不完全，nova-compute 不经过修改无法在龙芯平台上正常运行。修改过的 Nova 代码见 <a href=https://github.com/FreeFlyingSheep/Nova>https://github.com/FreeFlyingSheep/Nova</a>。</p><h3 id=修改-cpu-模式>修改 CPU 模式<a hidden class=anchor aria-hidden=true href=#修改-cpu-模式>#</a></h3><p>在未修改 CPU 模式时，运行 DevStack，尝试创建虚拟机时报错，查看日志显示 libvirt 内部错误，未知 CPU 类型 <code>qemu64</code>。</p><p>查看 nova-compute 配置文件发现 DevStack 默认 CPU 模式设置为 <code>none</code>，尝试改为 <code>host-model</code> 和 <code>host-passthrough</code>，依然报 libvirt 内部错误，但错误内容变为不支持这两种模式。</p><p>查看 libvirt 源码，定位报错的位置，发现龙芯平台上的 libvirt 实现并不完全，去把这些接口都实现了显然不现实。考虑到龙芯平台通过修改过的 virt-manager 是能正常创建虚拟机的，就想到比较龙芯平台的 virt-manager 创建虚拟机的参数和 nova-compute 默认创建的参数（主要比较生成的给 libvirt 使用的 xml 文件）。</p><p>对比发现，virt-manager 生成的 xml 文件中，使用的是 <code>custom</code> 模式，模拟 <code>Loongson-3A4000</code>。修改 nova-compute 的配置文件，设置这两个参数，错误变为了没有使用 PCIe。</p><h3 id=修改-pcie-配置>修改 PCIe 配置<a hidden class=anchor aria-hidden=true href=#修改-pcie-配置>#</a></h3><p>查看 Nova 源码，直接强制检查 PCIe 的函数对于 mips64el 架构返回 <code>True</code>。该部分代码位于 <code>virt/libvirt/driver.py</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_guest_needs_pcie</span>(self, guest, caps):
    <span style=color:#e6db74>&#34;&#34;&#34;Check for prerequisites for adding PCIe root port
</span><span style=color:#e6db74>    controllers
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>if</span> caps<span style=color:#f92672>.</span>host<span style=color:#f92672>.</span>cpu<span style=color:#f92672>.</span>arch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>MIPS64EL:
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> CONF<span style=color:#f92672>.</span>libvirt<span style=color:#f92672>.</span>num_pcie_ports:
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
    <span style=color:#66d9ef>if</span> (caps<span style=color:#f92672>.</span>host<span style=color:#f92672>.</span>cpu<span style=color:#f92672>.</span>arch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>AARCH64 <span style=color:#f92672>and</span>
            guest<span style=color:#f92672>.</span>os_mach_type<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;virt&#39;</span>)):
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
    <span style=color:#66d9ef>if</span> (caps<span style=color:#f92672>.</span>host<span style=color:#f92672>.</span>cpu<span style=color:#f92672>.</span>arch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>X86_64 <span style=color:#f92672>and</span>
            guest<span style=color:#f92672>.</span>os_mach_type <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>and</span>
            <span style=color:#e6db74>&#39;q35&#39;</span> <span style=color:#f92672>in</span> guest<span style=color:#f92672>.</span>os_mach_type):
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</code></pre></td></tr></table></div></div><p>重启 Nova 服务，发现虚拟机创建成功，但无法运行，错误变为了没法加载 BIOS。</p><h3 id=添加其他参数>添加其他参数<a hidden class=anchor aria-hidden=true href=#添加其他参数>#</a></h3><p>继续比较 xml 文件，发现 virt-manager 生成的 xml 会指定 BIOS 文件和其他相关参数，查看 Nova 源码，将这部分内容写到对应位置。代码位于 <code>virt/libvirt/driver.py</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_configure_guest_by_virt_type</span>(self, guest, virt_type, caps, instance,
                                  image_meta, flavor, root_device_name,
                                  sev_enabled):
    <span style=color:#66d9ef>if</span> virt_type <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;xen&#34;</span>:
        <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>elif</span> virt_type <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;kvm&#34;</span>, <span style=color:#e6db74>&#34;qemu&#34;</span>):
        <span style=color:#66d9ef>if</span> caps<span style=color:#f92672>.</span>host<span style=color:#f92672>.</span>cpu<span style=color:#f92672>.</span>arch <span style=color:#f92672>in</span> (fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>I686,
                                    fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>X86_64):
            guest<span style=color:#f92672>.</span>sysinfo <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_get_guest_config_sysinfo(instance)
            guest<span style=color:#f92672>.</span>os_smbios <span style=color:#f92672>=</span> vconfig<span style=color:#f92672>.</span>LibvirtConfigGuestSMBIOS()
        hw_firmware_type <span style=color:#f92672>=</span> image_meta<span style=color:#f92672>.</span>properties<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;hw_firmware_type&#39;</span>)
        <span style=color:#f92672>...</span>
        <span style=color:#66d9ef>if</span> image_meta<span style=color:#f92672>.</span>properties<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;hw_boot_menu&#39;</span>) <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
            guest<span style=color:#f92672>.</span>os_bootmenu <span style=color:#f92672>=</span> strutils<span style=color:#f92672>.</span>bool_from_string(
                flavor<span style=color:#f92672>.</span>extra_specs<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;hw:boot_menu&#39;</span>, <span style=color:#e6db74>&#39;no&#39;</span>))
        <span style=color:#66d9ef>else</span>:
            guest<span style=color:#f92672>.</span>os_bootmenu <span style=color:#f92672>=</span> image_meta<span style=color:#f92672>.</span>properties<span style=color:#f92672>.</span>hw_boot_menu
        <span style=color:#66d9ef>if</span> caps<span style=color:#f92672>.</span>host<span style=color:#f92672>.</span>cpu<span style=color:#f92672>.</span>arch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>MIPS64EL:
            guest<span style=color:#f92672>.</span>os_loader <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/usr/share/qemu/bios_loongson3.bin&#34;</span>
            guest<span style=color:#f92672>.</span>os_loader_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rom&#34;</span>
            guest<span style=color:#f92672>.</span>os_mach_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;loongson3-virt&#34;</span>

    <span style=color:#66d9ef>elif</span> virt_type <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;lxc&#34;</span>:
        <span style=color:#f92672>...</span>
</code></pre></td></tr></table></div></div><p>重启 Nova 服务，发现虚拟机成功创建，并运行，但控制台界面卡在了加载内核。</p><h3 id=修改显示模式后来又改回去了>修改显示模式（后来又改回去了）<a hidden class=anchor aria-hidden=true href=#修改显示模式后来又改回去了>#</a></h3><p>查看日志，发现并没有任何报错。思考了一会，推测是内核其实已经成功启动，但没正常显示。</p><p>继续对比 xml 文件，发现 nova-compute 默认使用的显卡设备模型为 <code>cirrus</code>，而 virt-manager 使用的显卡设备模型为 <code>qxl</code>。在 virt-manager 的选项中，没有找到 <code>cirrus</code> 显卡设备模型，怀疑不支持。</p><p>于是修改 nova-compute 相关代码，使它在 mips64 架构下默认使用 <code>qxl</code>。该部分代码位于 <code>virt/libvirt/driver.py</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_add_video_driver</span>(self, guest, image_meta, flavor):
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>if</span> guest<span style=color:#f92672>.</span>os_type <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>VMMode<span style=color:#f92672>.</span>XEN:
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;xen&#39;</span>
    <span style=color:#66d9ef>elif</span> CONF<span style=color:#f92672>.</span>libvirt<span style=color:#f92672>.</span>virt_type <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;parallels&#39;</span>:
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;vga&#39;</span>
    <span style=color:#66d9ef>elif</span> guestarch <span style=color:#f92672>in</span> (fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>PPC,
                        fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>PPC64,
                        fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>PPC64LE):
        <span style=color:#75715e># NOTE(ldbragst): PowerKVM doesn&#39;t support &#39;cirrus&#39; be default</span>
        <span style=color:#75715e># so use &#39;vga&#39; instead when running on Power hardware.</span>
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;vga&#39;</span>
    <span style=color:#66d9ef>elif</span> guestarch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>AARCH64:
        <span style=color:#75715e># NOTE(kevinz): Only virtio device type is supported by AARCH64</span>
        <span style=color:#75715e># so use &#39;virtio&#39; instead when running on AArch64 hardware.</span>
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;virtio&#39;</span>
    <span style=color:#66d9ef>elif</span> (CONF<span style=color:#f92672>.</span>spice<span style=color:#f92672>.</span>enabled) <span style=color:#f92672>or</span> (guestarch <span style=color:#f92672>==</span> fields<span style=color:#f92672>.</span>Architecture<span style=color:#f92672>.</span>MIPS64):
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;qxl&#39;</span>
    <span style=color:#66d9ef>if</span> image_meta<span style=color:#f92672>.</span>properties<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;hw_video_model&#39;</span>):
        video<span style=color:#f92672>.</span>type <span style=color:#f92672>=</span> image_meta<span style=color:#f92672>.</span>properties<span style=color:#f92672>.</span>hw_video_model
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>_video_model_supported(video<span style=color:#f92672>.</span>type):
            <span style=color:#66d9ef>raise</span> exception<span style=color:#f92672>.</span>InvalidVideoMode(model<span style=color:#f92672>=</span>video<span style=color:#f92672>.</span>type)
    <span style=color:#f92672>...</span>
</code></pre></td></tr></table></div></div><p>重启 Nova 服务，这次控制台界面显示出了开机动画，但发现键盘没有反应。</p><h3 id=添加键盘设备>添加键盘设备<a hidden class=anchor aria-hidden=true href=#添加键盘设备>#</a></h3><p>鼠标能动但键盘没有反应，推测使没添加键盘，查看 xml 发现果然如此。</p><p>在 Nova 中添加键盘。该部分代码位于 <code>virt/libvirt/driver.py</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>def _get_guest_config<span style=color:#f92672>(</span>self, instance, network_info, image_meta,
                      disk_info, rescue<span style=color:#f92672>=</span>None, block_device_info<span style=color:#f92672>=</span>None,
                      context<span style=color:#f92672>=</span>None, mdevs<span style=color:#f92672>=</span>None, accel_info<span style=color:#f92672>=</span>None<span style=color:#f92672>)</span>:
    <span style=color:#e6db74>&#34;&#34;&#34;Get config data for parameters.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    :param rescue: optional dictionary that should contain the key
</span><span style=color:#e6db74>        &#39;ramdisk_id&#39; if a ramdisk is needed for the rescue image and
</span><span style=color:#e6db74>        &#39;kernel_id&#39; if a kernel is needed for the rescue image.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    :param mdevs: optional list of mediated devices to assign to the guest.
</span><span style=color:#e6db74>    :param accel_info: optional list of accelerator requests (ARQs)
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
    ...
    self._guest_add_spice_channel<span style=color:#f92672>(</span>guest<span style=color:#f92672>)</span>

    <span style=color:#66d9ef>if</span> self._guest_add_video_device<span style=color:#f92672>(</span>guest<span style=color:#f92672>)</span>:
        self._add_video_driver<span style=color:#f92672>(</span>guest, image_meta, flavor<span style=color:#f92672>)</span>

        <span style=color:#75715e># We want video == we want graphical console. Some architectures</span>
        <span style=color:#75715e># do not have input devices attached in default configuration.</span>
        <span style=color:#75715e># Let then add USB Host controller and USB keyboard.</span>
        <span style=color:#75715e># x86(-64) and ppc64 have usb host controller and keyboard</span>
        <span style=color:#75715e># s390x does not support USB</span>
        <span style=color:#66d9ef>if</span> caps.host.cpu.arch in <span style=color:#f92672>(</span>fields.Architecture.AARCH64,
                                    fields.Architecture.MIPS64EL<span style=color:#f92672>)</span>:
            self._guest_add_usb_host_keyboard<span style=color:#f92672>(</span>guest<span style=color:#f92672>)</span>

    <span style=color:#75715e># Some features are only supported &#39;qemu&#39; and &#39;kvm&#39; hypervisor</span>
    <span style=color:#66d9ef>if</span> virt_type in <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;qemu&#39;</span>, <span style=color:#e6db74>&#39;kvm&#39;</span><span style=color:#f92672>)</span>:
        self._set_qemu_guest_agent<span style=color:#f92672>(</span>guest, flavor, instance, image_meta<span style=color:#f92672>)</span>
        self._add_rng_device<span style=color:#f92672>(</span>guest, flavor, image_meta<span style=color:#f92672>)</span>
        self._add_vtpm_device<span style=color:#f92672>(</span>guest, flavor, instance, image_meta<span style=color:#f92672>)</span>
    ...
</code></pre></td></tr></table></div></div><p>重启 Nova 服务，键盘能正常使用了，但鼠标能移动却无法点击。</p><h3 id=改用-spice>改用 spice<a hidden class=anchor aria-hidden=true href=#改用-spice>#</a></h3><p>听取同事建议后，索性改用 spice 协议，而不是 vnc 协议。这样可以移除 Nova 中显示模式部分的修改，鼠标也能正常使用了。</p><p>对于 DevStack，只需要修改配置文件 <code>local.conf</code> 即可，添加两行内容：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>enable_service n-spice n-sproxy
disable_service n-novnc n-xvnc
</code></pre></td></tr></table></div></div><h2 id=其他问题>其他问题<a hidden class=anchor aria-hidden=true href=#其他问题>#</a></h2><p>创建虚拟机的过程中，一旦涉及 Cinder 服务，就会报错，因此暂时使用了 Nova 自带的创建卷功能。</p><p>成功把 Nova 跑通后，开始解决 Cinder 无法映射块设备的问题。查看日志报错信息，发现是创建 LVM 卷的时候出错了。</p><p>根据网上资料手动创建 LVM 卷，复现了报错信息，只要是使用 <code>thin</code> 模式，创建卷就会报错，这应该是系统中相关的软件包存在问题，暂时将 cinder 的 LVM 模式更换为 <code>default</code>，绕过了这个问题，成功创建了卷。</p><p>还有一些问题，但暂时没想到解决办法。比如内核没有输出日志信息，检查 xml 确定已经重定向到了 <code>console.log</code>，内核启动也添加了相关参数。还有从 ISO 文件创建虚拟机时会报找不到设备等问题（由于系统的 QEMU/KVM 只支持龙芯的镜像，所以必须使用提前准备好的镜像）。</p><p>对于 DevStack，最终的 <code>local.conf</code> 配置如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[[local|localrc]]
FORCE=yes

ADMIN_PASSWORD=123456
DATABASE_PASSWORD=$ADMIN_PASSWORD
RABBIT_PASSWORD=$ADMIN_PASSWORD
SERVICE_PASSWORD=$ADMIN_PASSWORD

GIT_BASE=https://github.com
NOVA_REPO=https://github.com/FreeFlyingSheep/nova.git

ETCD_DOWNLOAD_URL=https://fake-url

DOWNLOAD_DEFAULT_IMAGES=False
IMAGE_URLS=https://fake-url/fedora28.qcow2

CINDER_LVM_TYPE=default

enable_service n-spice n-sproxy
disable_service n-novnc n-xvnc
</code></pre></td></tr></table></div></div><p>至此，OpenStack 的移植初步完成了，到了勉强能用的地步。因为暂时没有后续的需求，所以先到此为止了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://freeflyingsheep.github.io/tags/openstack/>OpenStack</a></li></ul><nav class=paginav><a class=prev href=https://freeflyingsheep.github.io/posts/leetcode/leetcode/><span class=title>«</span><br><span>LeetCode 刷题笔记</span></a>
<a class=next href=https://freeflyingsheep.github.io/posts/openstack/introduction/><span class=title>»</span><br><span>OpenStack 简介</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://freeflyingsheep.github.io/>FreeFlyingSheep 的小站</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>