<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux/MIPS 启动 | FreeFlyingSheep 的小站</title><meta name=keywords content="Linux 内核,MIPS"><meta name=description content="阅读 MIPS 启动部分的代码，从内核入口 kernel_entry 到 start_kernel 的第一个子函数 lock_kernel，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 C 标注。"><meta name=author content="FreeFlyingSheep"><link rel=canonical href=https://freeflyingsheep.github.io/posts/tips/mips-boot/><link crossorigin=anonymous href=/assets/css/stylesheet.min.35cd0f65a15cafa92372b8313deef5960aae04b90ad722f2bbf509eb0468137e.css integrity="sha256-Nc0PZaFcr6kjcrgxPe71lgquBLkK1yLyu/UJ6wRoE34=" rel="preload stylesheet" as=style><link rel=preload href=/avatar.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://freeflyingsheep.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://freeflyingsheep.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://freeflyingsheep.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://freeflyingsheep.github.io/apple-touch-icon.png><link rel=mask-icon href=https://freeflyingsheep.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><meta property="og:title" content="Linux/MIPS 启动"><meta property="og:description" content="阅读 MIPS 启动部分的代码，从内核入口 kernel_entry 到 start_kernel 的第一个子函数 lock_kernel，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 C 标注。"><meta property="og:type" content="article"><meta property="og:url" content="https://freeflyingsheep.github.io/posts/tips/mips-boot/"><meta property="og:image" content="https://freeflyingsheep.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-17T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-17T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://freeflyingsheep.github.io/papermod-cover.png"><meta name=twitter:title content="Linux/MIPS 启动"><meta name=twitter:description content="阅读 MIPS 启动部分的代码，从内核入口 kernel_entry 到 start_kernel 的第一个子函数 lock_kernel，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 C 标注。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://freeflyingsheep.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Linux/MIPS 启动","item":"https://freeflyingsheep.github.io/posts/tips/mips-boot/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux/MIPS 启动","name":"Linux\/MIPS 启动","description":"阅读 MIPS 启动部分的代码，从内核入口 kernel_entry 到 start_kernel 的第一个子函数 lock_kernel，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 C 标注。\n","keywords":["Linux 内核","MIPS"],"articleBody":"阅读 MIPS 启动部分的代码，从内核入口 kernel_entry 到 start_kernel 的第一个子函数 lock_kernel，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 C 标注。\n函数 kernel_entry arch/mips/kernel/head.S：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  NESTED(kernel_entry, 16, sp) # kernel entry point setup_c0_status_pri #ifdef CONFIG_SGI_IP27  GET_NASID_ASM t1 move t2, t1 # text and data are here // t2 = t1  MAPPED_KERNEL_SETUP_TLB #endif /* IP27 */ ARC64_TWIDDLE_PC PTR_LA t0, __bss_start # clear .bss // t0 = __bss_start  LONG_S zero, (t0) // *(t0) = 0  PTR_LA t1, __bss_stop - LONGSIZE // t1 = __bss_stop - LONGSIZE 1: PTR_ADDIU t0, LONGSIZE // t0 += LONGSIZE  LONG_S zero, (t0) // *(t0) = 0  bne t0, t1, 1b // if (t0 != t1) goto 1b  LONG_S a0, fw_arg0 # firmware arguments LONG_S a1, fw_arg1 LONG_S a2, fw_arg2 LONG_S a3, fw_arg3 PTR_LA $28, init_thread_union // gp = init_thread_union  PTR_ADDIU sp, $28, _THREAD_SIZE - 32 // sp = gp + _THREAD_SIZE - 32  set_saved_sp sp, t0, t1 PTR_SUBU sp, 4 * SZREG # init stack pointer // sp = 4 * SZREG  j start_kernel END(kernel_entry)   init_thread_union 定义于 arch/mips/kernel/init_task.c。\nstart_kernel init/main.c：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  /* * Activate the first processor. */ asmlinkage void __init start_kernel(void) { char * command_line; extern struct kernel_param __start___param[], __stop___param[]; /* * Interrupts are still disabled. Do necessary setups, then * enable them */ lock_kernel(); ...   lock_kernel include/linux/smp_lock.h：\n1 2 3 4 5 6 7 8 9 10 11  #ifdef CONFIG_LOCK_KERNEL  extern void __lockfunc lock_kernel(void) __acquires(kernel_lock); extern void __lockfunc unlock_kernel(void) __releases(kernel_lock); #else  #define lock_kernel() do { } while(0) #define unlock_kernel() do { } while(0)  #endif /* CONFIG_LOCK_KERNEL */  lock_kernel 和 unlock_kernel 的具体实现在 lib/kernel_lock.c 中。\n汇编器指令 主要参考文档 Using as。\n.set noreorder 设置汇编器不移动指令来填充延迟槽。\n.set push 和 .set pop 见 Directives to save and restore options。\n可以先用 .set push 保存汇编器配置，然后执行一些修改 (比如配置 .set noreorder)，最后用 .set pop 恢复之前的汇编器配置。\n.comm 见 .comm symbol , length。\n在大部分情况下，可以简单理解为定义一个变量，变量名为 symbol ，占 length 字节，可选的第三个参数代表对齐字节数。\n.align [abs-expr[, abs-expr[, abs-expr]]] 见 .align [abs-expr[, abs-expr[, abs-expr]]]。\n通常只用到第一个表达式，如 .align 8 代表 8 字节对齐。\n.type 见 .type。\n在内核中，基本只用到了 .type ,@ 的形式，用于表明函数类型。\n.globl 见 .globl。\n声明变量 (供链接器使用)。\n.ent 声明变量 (供调试器使用)。\n.frame .frame sp, size, ra，提供给调试器关于栈帧的信息，sp 代表指向栈帧的地址、寄存器，size 代表栈帧的大小，ra 代表保存返回地址的寄存器。\n.section 见 .section name。\n.previous 见 .previous。\n.macro 和 .endm 见 .macro。\n宏 EXPORT include/asm-mips/asm.h：\n1 2 3 4 5 6  /* * EXPORT - export definition of symbol */ #define EXPORT(symbol) \\ .globl symbol; \\ symbol:   声明一个全局变量。\n__INIT 和 __FINIT include/linux/init.h：\n1 2  #define __INIT .section \".init.text\",\"ax\" #define __FINIT .previous   .section 和 .previous 见汇编器指令章节的相关内容。\n32 位和 64 位的兼容 32 位和 64 位情况下的数据长度和指令不同，具体见 include/asm-mips/asm.h，该文件中的部分宏定义如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  /* * Size of a register */ #ifdef __mips64 #define SZREG 8 #else #define SZREG 4 #endif  /* * How to add/sub/load/store/shift C long variables. */ #if (_MIPS_SZLONG == 32) #define LONG_S sw #endif  #if (_MIPS_SZLONG == 64) #define LONG_S sd #endif  /* * How to add/sub/load/store/shift pointers. */ #if (_MIPS_SZPTR == 32) #define PTR_ADDIU addiu #define PTR_SUBU subu #define PTR_LA la #endif  #if (_MIPS_SZPTR == 64) #define PTR_ADDU daddu #define PTR_SUBU dsubu #define PTR_LA dla #endif   NESTED include/asm-mips/asm.h：\n1 2 3 4 5 6 7 8 9  /* * NESTED - declare nested routine entry point */ #define NESTED(symbol, framesize, rpc) \\ .globl symbol; \\ .align 2; \\ .type symbol,@function; \\ .ent symbol,0; \\ symbol: .frame sp, framesize, rpc   定义一个函数的头部。\nsetup_c0_status_pri arch/mips/kernel/head.S：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  /* * For the moment disable interrupts, mark the kernel mode and * set ST0_KX so that the CPU does not spit fire when using * 64-bit addresses. A full initialization of the CPU's status * register is done later in per_cpu_trap_init(). */ .macro setup_c0_status set clr .set push mfc0 t0, CP0_STATUS // t0 = $12  or t0, ST0_CU0|\\set|0x1f|\\clr // t0 |= ST0_CU0 | set | 0x1f | clr  xor t0, 0x1f|\\clr // t0 ^= 0x1f | clr  mtc0 t0, CP0_STATUS // $12 = t0  .set noreorder sll zero,3 # ehb .set pop .endm .macro setup_c0_status_pri #ifdef CONFIG_MIPS64  setup_c0_status ST0_KX 0 // setup_c0_status 0x00000080 0，见宏章节的 CP0 寄存器 #else  setup_c0_status 0 0 // setup_c0_status 0 0 #endif  .endm   如果配置了 CONFIG_MIPS64，setup_c0_status 会把 CP0 的 $12 设置为 0x80；反之则设置为 0。具体作用注释已经给出，建议参考 The MIPS64 and microMIPS64 Privileged Resource Architecture v6.03 的 Table 9.49。\nCP0 寄存器 include/asm-mips/mipsregs.h：\n1 2 3 4 5 6 7 8 9  /* * Coprocessor 0 register names */ #define CP0_STATUS $12  /* * Bitfields in the R4xx0 cp0 status register */ #define ST0_KX 0x00000080   GET_NASID_ASM arch/mips/kernel/head.S：\n1 2 3 4 5 6 7 8 9 10 11  #ifdef CONFIG_SGI_IP27  /* * outputs the local nasid into res. IP27 stuff. */ .macro GET_NASID_ASM res dli \\res, LOCAL_HUB_ADDR(NI_STATUS_REV_ID) ld \\res, (\\res) and \\res, NSRI_NODEID_MASK dsrl \\res, NSRI_NODEID_SHFT .endm #endif /* CONFIG_SGI_IP27 */  MAPPED_KERNEL_SETUP_TLB 定义于 arch/mips/kernel/head.S。\nARC64_TWIDDLE_PC arch/mips/kernel/head.S：\n1 2 3 4 5 6 7 8 9  .macro ARC64_TWIDDLE_PC #if defined(CONFIG_ARC64) || defined(CONFIG_MAPPED_KERNEL)  /* We get launched at a XKPHYS address but the kernel is linked to run at a KSEG0 address, so jump there. */ PTR_LA t0, \\@f jr t0 \\@: #endif  .endm   _THREAD_SIZE 定义于 arch/mips/kernel/offset.c ，该文件会根据 arch/mips/Makefile 中的规则，生成 asm/offset.h。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  # Generate  # # The default rule is suffering from funny problems on MIPS so we using our # own ... # # ---------------------------------------------------------------------------  define filechk_gen-asm-offset.h (set -e; \\ echo \"#ifndef _ASM_OFFSET_H\"; \\ echo \"#define _ASM_OFFSET_H\"; \\ echo \"/*\"; \\ echo \" * DO NOT MODIFY.\"; \\ echo \" *\"; \\ echo \" * This file was generated by arch/$(ARCH)/Makefile\"; \\ echo \" *\"; \\ echo \" */\"; \\ echo \"\"; \\ sed -ne \"/^@@@/s///p\"; \\ echo \"#endif /* _ASM_OFFSET_H */\" ) endef prepare: include/asm-$(ARCH)/offset.h arch/$(ARCH)/kernel/offset.s: include/asm include/linux/version.h \\ include/config/MARKER include/asm-$(ARCH)/offset.h: arch/$(ARCH)/kernel/offset.s $(call filechk,gen-asm-offset.h)   Makefile：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  # filechk is used to check if the content of a generated file is updated. # Sample usage: # define filechk_sample # echo $KERNELRELEASE # endef # version.h : Makefile # $(call filechk,sample) # The rule defined shall write to stdout the content of the new file. # The existing file will be compared with the new one. # - If no file exist it is created # - If the content differ the new file is used # - If they are equal no change, and no timestamp update  define filechk @set -e; \\ echo ' CHK $@'; \\ mkdir -p $(dir $@); \\ $(filechk_$(1))  $  $@.tmp; \\ if [ -r $@ ] \u0026\u0026 cmp -s $@ $@.tmp; then \\ rm -f $@.tmp; \\ else \\ echo ' UPD $@'; \\ mv -f $@.tmp $@; \\ fi endef   查看文件中 _THREAD_SIZE 相关代码，最终该宏相当于 #define _THREAD_SIZE THREAD_SIZE。\nTHREAD_SIZE include/asm-mips/thread_info.h：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  /* thread information allocation */ #if defined(CONFIG_PAGE_SIZE_4KB) \u0026\u0026 defined(CONFIG_MIPS32) #define THREAD_SIZE_ORDER (1) #endif #if defined(CONFIG_PAGE_SIZE_4KB) \u0026\u0026 defined(CONFIG_MIPS64) #define THREAD_SIZE_ORDER (2) #endif #ifdef CONFIG_PAGE_SIZE_8KB #define THREAD_SIZE_ORDER (1) #endif #ifdef CONFIG_PAGE_SIZE_16KB #define THREAD_SIZE_ORDER (0) #endif #ifdef CONFIG_PAGE_SIZE_64KB #define THREAD_SIZE_ORDER (0) #endif  #define THREAD_SIZE (PAGE_SIZE   include/asm-mips/page.h：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  /* * PAGE_SHIFT determines the page size */ #ifdef CONFIG_PAGE_SIZE_4KB #define PAGE_SHIFT 12 #endif #ifdef CONFIG_PAGE_SIZE_8KB #define PAGE_SHIFT 13 #endif #ifdef CONFIG_PAGE_SIZE_16KB #define PAGE_SHIFT 14 #endif #ifdef CONFIG_PAGE_SIZE_64KB #define PAGE_SHIFT 16 #endif #define PAGE_SIZE (1UL   set_saved_sp 定义于 include/asm-mips/stackframe.h，见后续笔记。\nEND 1 2 3 4 5 6  /* * END - mark end of function */ #define END(function) \\ .end function; \\ .size function,.-function   定义一个函数的尾部。\nCP0_STATUS include/asm-mips/mipsregs.h：\n1  #define CP0_STATUS $12   CONFIG_SGI_IP27 arch/mips/Makefile:\n1 2 3 4 5 6 7  # # SGI-IP27 (Origin200/2000) # # Set the load address to = 0xc000000000300000 if you want to leave space for # symmon, 0xc00000000001c000 for production kernels. Note that the value must # be 16kb aligned or the handling of the current variable will break. #   asmlinkage include/linux/linkage.h：\n1 2 3 4 5 6 7 8 9 10 11  #include  #ifdef __cplusplus #define CPP_ASMLINKAGE extern \"C\" #else #define CPP_ASMLINKAGE #endif  #ifndef asmlinkage #define asmlinkage CPP_ASMLINKAGE #endif   include/asm-mips/linkage.h：\n1  /* Nothing to see here... */   在 MIPS 下，asmlinkage 只是为了兼容 C++。\n__init include/linux/init.h：\n1  #define __init __attribute__ ((__section__ (\".init.text\")))   把函数放到 .init.text 段。\n__acquires 和 __releases include/linux/compiler.h：\n1 2  # define __acquires(x) __attribute__((context(0,1))) # define __releases(x) __attribute__((context(1,0)))   给 Sparse 做代码静态检查，用于保证 __acquires 和 __releases 成对使用。Sparse 的相关内容可以参考 The Linux Kernel documentation。\n__lockfunc include/linux/spinlock.h：\n1  #define __lockfunc fastcall __attribute__((section(\".spinlock.text\")))   include/linux/linkage.h：\n1 2 3 4  #ifndef FASTCALL #define FASTCALL(x) x #define fastcall #endif   include/asm-mips/linkage.h：\n1  /* Nothing to see here... */   在 MIPS 下，fastcall 为空，__lockfunc 只是为了把函数放到 .spinlock.text 段。\n","wordCount":"1514","inLanguage":"zh-cn","datePublished":"2020-07-17T00:00:00Z","dateModified":"2020-07-17T00:00:00Z","author":{"@type":"Person","name":"FreeFlyingSheep"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://freeflyingsheep.github.io/posts/tips/mips-boot/"},"publisher":{"@type":"Organization","name":"FreeFlyingSheep 的小站","logo":{"@type":"ImageObject","url":"https://freeflyingsheep.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://freeflyingsheep.github.io/ accesskey=h title="FreeFlyingSheep 的小站 (Alt + H)">FreeFlyingSheep 的小站</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://freeflyingsheep.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://freeflyingsheep.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://freeflyingsheep.github.io/series title=Series><span>Series</span></a></li><li><a href=https://freeflyingsheep.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://freeflyingsheep.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://freeflyingsheep.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://freeflyingsheep.github.io/posts/>Posts</a></div><h1 class=post-title>Linux/MIPS 启动</h1><div class=post-meta>July 17, 2020&nbsp;·&nbsp;8 min&nbsp;·&nbsp;FreeFlyingSheep</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#%e5%87%bd%e6%95%b0 aria-label=函数>函数</a><ul><li><a href=#kernel_entry aria-label=kernel_entry><code>kernel_entry</code></a></li><li><a href=#start_kernel aria-label=start_kernel><code>start_kernel</code></a></li><li><a href=#lock_kernel aria-label=lock_kernel><code>lock_kernel</code></a></li></ul></li><li><a href=#%e6%b1%87%e7%bc%96%e5%99%a8%e6%8c%87%e4%bb%a4 aria-label=汇编器指令>汇编器指令</a><ul><li><a href=#set-noreorder aria-label=".set noreorder"><code>.set noreorder</code></a></li><li><a href=#set-push-%e5%92%8c-set-pop aria-label=".set push 和 .set pop"><code>.set push</code> 和 <code>.set pop</code></a></li><li><a href=#comm aria-label=.comm><code>.comm</code></a></li><li><a href=#align-abs-expr-abs-expr-abs-expr aria-label=".align [abs-expr[, abs-expr[, abs-expr]]]"><code>.align [abs-expr[, abs-expr[, abs-expr]]]</code></a></li><li><a href=#type aria-label=.type><code>.type</code></a></li><li><a href=#globl aria-label=.globl><code>.globl</code></a></li><li><a href=#ent aria-label=.ent><code>.ent</code></a></li><li><a href=#frame aria-label=.frame><code>.frame</code></a></li><li><a href=#section aria-label=.section><code>.section</code></a></li><li><a href=#previous aria-label=.previous><code>.previous</code></a></li><li><a href=#macro-%e5%92%8c-endm aria-label=".macro 和 .endm"><code>.macro</code> 和 <code>.endm</code></a></li></ul></li><li><a href=#%e5%ae%8f aria-label=宏>宏</a><ul><li><a href=#export aria-label=EXPORT><code>EXPORT</code></a></li><li><a href=#__init-%e5%92%8c-__finit aria-label="__INIT 和 __FINIT"><code>__INIT</code> 和 <code>__FINIT</code></a></li><li><a href=#32-%e4%bd%8d%e5%92%8c-64-%e4%bd%8d%e7%9a%84%e5%85%bc%e5%ae%b9 aria-label="32 位和 64 位的兼容">32 位和 64 位的兼容</a></li><li><a href=#nested aria-label=NESTED><code>NESTED</code></a></li><li><a href=#setup_c0_status_pri aria-label=setup_c0_status_pri><code>setup_c0_status_pri</code></a></li><li><a href=#cp0-%e5%af%84%e5%ad%98%e5%99%a8 aria-label="CP0 寄存器">CP0 寄存器</a></li><li><a href=#get_nasid_asm aria-label=GET_NASID_ASM><code>GET_NASID_ASM</code></a></li><li><a href=#mapped_kernel_setup_tlb aria-label=MAPPED_KERNEL_SETUP_TLB><code>MAPPED_KERNEL_SETUP_TLB</code></a></li><li><a href=#arc64_twiddle_pc aria-label=ARC64_TWIDDLE_PC><code>ARC64_TWIDDLE_PC</code></a></li><li><a href=#_thread_size aria-label=_THREAD_SIZE><code>_THREAD_SIZE</code></a></li><li><a href=#thread_size aria-label=THREAD_SIZE><code>THREAD_SIZE</code></a></li><li><a href=#set_saved_sp aria-label=set_saved_sp><code>set_saved_sp</code></a></li><li><a href=#end aria-label=END><code>END</code></a></li><li><a href=#cp0_status aria-label=CP0_STATUS><code>CP0_STATUS</code></a></li><li><a href=#config_sgi_ip27 aria-label=CONFIG_SGI_IP27><code>CONFIG_SGI_IP27</code></a></li><li><a href=#asmlinkage aria-label=asmlinkage><code>asmlinkage</code></a></li><li><a href=#__init aria-label=__init><code>__init</code></a></li><li><a href=#__acquires-%e5%92%8c-__releases aria-label="__acquires 和 __releases"><code>__acquires</code> 和 <code>__releases</code></a></li><li><a href=#__lockfunc aria-label=__lockfunc><code>__lockfunc</code></a></li></ul></li></ul></div></details></div><div class=post-content><p>阅读 MIPS 启动部分的代码，从内核入口 <code>kernel_entry</code> 到 <code>start_kernel</code> 的第一个子函数 <code>lock_kernel</code>，很多细节我并没理解，所以不进行展开。基于 Linux kernel release 2.6.11.12。由于 Markdown 代码块语法高亮不支持汇编，此处统一用 <code>C</code> 标注。</p><h2 id=函数>函数<a hidden class=anchor aria-hidden=true href=#函数>#</a></h2><h3 id=kernel_entry><code>kernel_entry</code><a hidden class=anchor aria-hidden=true href=#kernel_entry>#</a></h3><p><code>arch/mips/kernel/head.S</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>NESTED(kernel_entry, <span style=color:#ae81ff>16</span>, sp) <span style=color:#960050;background-color:#1e0010>#</span> kernel entry point
    setup_c0_status_pri

<span style=color:#75715e>#ifdef CONFIG_SGI_IP27
</span><span style=color:#75715e></span>    GET_NASID_ASM t1
    move t2, t1 <span style=color:#960050;background-color:#1e0010>#</span> text and data are here <span style=color:#75715e>// t2 = t1
</span><span style=color:#75715e></span>    MAPPED_KERNEL_SETUP_TLB
<span style=color:#75715e>#endif </span><span style=color:#75715e>/* IP27 */</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
    ARC64_TWIDDLE_PC

    PTR_LA t0, __bss_start <span style=color:#960050;background-color:#1e0010>#</span> clear .bss <span style=color:#75715e>// t0 = __bss_start
</span><span style=color:#75715e></span>    LONG_S zero, (t0) <span style=color:#75715e>// *(t0) = 0
</span><span style=color:#75715e></span>    PTR_LA t1, __bss_stop <span style=color:#f92672>-</span> LONGSIZE <span style=color:#75715e>// t1 = __bss_stop - LONGSIZE
</span><span style=color:#75715e></span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
    PTR_ADDIU t0, LONGSIZE <span style=color:#75715e>// t0 += LONGSIZE
</span><span style=color:#75715e></span>    LONG_S zero, (t0) <span style=color:#75715e>// *(t0) = 0
</span><span style=color:#75715e></span>    bne t0, t1, <span style=color:#ae81ff>1</span>b <span style=color:#75715e>// if (t0 != t1) goto 1b
</span><span style=color:#75715e></span>
    LONG_S a0, fw_arg0 <span style=color:#960050;background-color:#1e0010>#</span> firmware arguments
    LONG_S a1, fw_arg1
    LONG_S a2, fw_arg2
    LONG_S a3, fw_arg3

    PTR_LA <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>28</span>, init_thread_union <span style=color:#75715e>// gp = init_thread_union
</span><span style=color:#75715e></span>    PTR_ADDIU sp, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>28</span>, _THREAD_SIZE <span style=color:#f92672>-</span> <span style=color:#ae81ff>32</span> <span style=color:#75715e>// sp = gp + _THREAD_SIZE - 32
</span><span style=color:#75715e></span>    set_saved_sp sp, t0, t1
    PTR_SUBU sp, <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> SZREG <span style=color:#960050;background-color:#1e0010>#</span> init stack pointer <span style=color:#75715e>// sp = 4 * SZREG
</span><span style=color:#75715e></span>
    j start_kernel
    END(kernel_entry)
</code></pre></td></tr></table></div></div><p><code>init_thread_union</code> 定义于 <code>arch/mips/kernel/init_task.c</code>。</p><h3 id=start_kernel><code>start_kernel</code><a hidden class=anchor aria-hidden=true href=#start_kernel>#</a></h3><p><code>init/main.c</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * Activate the first processor.
</span><span style=color:#75715e> */</span>

asmlinkage <span style=color:#66d9ef>void</span> __init <span style=color:#a6e22e>start_kernel</span>(<span style=color:#66d9ef>void</span>)
{
    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> command_line;
    <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>struct</span> kernel_param __start___param[], __stop___param[];
<span style=color:#75715e>/*
</span><span style=color:#75715e> * Interrupts are still disabled. Do necessary setups, then
</span><span style=color:#75715e> * enable them
</span><span style=color:#75715e> */</span>
    lock_kernel();
    ...
</code></pre></td></tr></table></div></div><h3 id=lock_kernel><code>lock_kernel</code><a hidden class=anchor aria-hidden=true href=#lock_kernel>#</a></h3><p><code>include/linux/smp_lock.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#ifdef CONFIG_LOCK_KERNEL
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> __lockfunc <span style=color:#a6e22e>lock_kernel</span>(<span style=color:#66d9ef>void</span>) __acquires(kernel_lock);
<span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> __lockfunc <span style=color:#a6e22e>unlock_kernel</span>(<span style=color:#66d9ef>void</span>) __releases(kernel_lock);

<span style=color:#75715e>#else
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define lock_kernel() do { } while(0)
</span><span style=color:#75715e>#define unlock_kernel() do { } while(0)
</span><span style=color:#75715e></span>
<span style=color:#75715e>#endif </span><span style=color:#75715e>/* CONFIG_LOCK_KERNEL */</span><span style=color:#75715e>
</span></code></pre></td></tr></table></div></div><p><code>lock_kernel</code> 和 <code>unlock_kernel</code> 的具体实现在 <code>lib/kernel_lock.c</code> 中。</p><h2 id=汇编器指令>汇编器指令<a hidden class=anchor aria-hidden=true href=#汇编器指令>#</a></h2><p>主要参考文档 <em><a href=https://sourceware.org/binutils/docs-2.34/as/index.html>Using as</a></em>。</p><h3 id=set-noreorder><code>.set noreorder</code><a hidden class=anchor aria-hidden=true href=#set-noreorder>#</a></h3><p>设置汇编器不移动指令来填充延迟槽。</p><h3 id=set-push-和-set-pop><code>.set push</code> 和 <code>.set pop</code><a hidden class=anchor aria-hidden=true href=#set-push-和-set-pop>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/MIPS-Option-Stack.html#index-_002eset-push>Directives to save and restore options</a>。</p><p>可以先用 <code>.set push</code> 保存汇编器配置，然后执行一些修改 (比如配置 <code>.set noreorder</code>)，最后用 <code>.set pop</code> 恢复之前的汇编器配置。</p><h3 id=comm><code>.comm</code><a hidden class=anchor aria-hidden=true href=#comm>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Comm.html#Comm><code>.comm symbol , length</code></a>。</p><p>在大部分情况下，可以简单理解为定义一个变量，变量名为 <code>symbol</code> ，占 <code>length</code> 字节，可选的第三个参数代表对齐字节数。</p><h3 id=align-abs-expr-abs-expr-abs-expr><code>.align [abs-expr[, abs-expr[, abs-expr]]]</code><a hidden class=anchor aria-hidden=true href=#align-abs-expr-abs-expr-abs-expr>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Align.html#Align><code>.align [abs-expr[, abs-expr[, abs-expr]]]</code></a>。</p><p>通常只用到第一个表达式，如 <code>.align 8</code> 代表 8 字节对齐。</p><h3 id=type><code>.type</code><a hidden class=anchor aria-hidden=true href=#type>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Type.html#Type><code>.type</code></a>。</p><p>在内核中，基本只用到了 <code>.type &lt;name>,@&lt;type></code> 的形式，用于表明函数类型。</p><h3 id=globl><code>.globl</code><a hidden class=anchor aria-hidden=true href=#globl>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Global.html#Global><code>.globl</code></a>。</p><p>声明变量 (供链接器使用)。</p><h3 id=ent><code>.ent</code><a hidden class=anchor aria-hidden=true href=#ent>#</a></h3><p>声明变量 (供调试器使用)。</p><h3 id=frame><code>.frame</code><a hidden class=anchor aria-hidden=true href=#frame>#</a></h3><p><code>.frame sp, size, ra</code>，提供给调试器关于栈帧的信息，<code>sp</code> 代表指向栈帧的地址、寄存器，<code>size</code> 代表栈帧的大小，<code>ra</code> 代表保存返回地址的寄存器。</p><h3 id=section><code>.section</code><a hidden class=anchor aria-hidden=true href=#section>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Section.html#Section><code>.section name</code></a>。</p><h3 id=previous><code>.previous</code><a hidden class=anchor aria-hidden=true href=#previous>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Previous.html#Previous><code>.previous</code></a>。</p><h3 id=macro-和-endm><code>.macro</code> 和 <code>.endm</code><a hidden class=anchor aria-hidden=true href=#macro-和-endm>#</a></h3><p>见 <a href=https://sourceware.org/binutils/docs-2.34/as/Macro.html#Macro><code>.macro</code></a>。</p><h2 id=宏>宏<a hidden class=anchor aria-hidden=true href=#宏>#</a></h2><h3 id=export><code>EXPORT</code><a hidden class=anchor aria-hidden=true href=#export>#</a></h3><p><code>include/asm-mips/asm.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e>* EXPORT - export definition of symbol
</span><span style=color:#75715e>*/</span>
<span style=color:#75715e>#define EXPORT(symbol)                  \
</span><span style=color:#75715e>        .globl  symbol;                         \
</span><span style=color:#75715e>symbol:
</span></code></pre></td></tr></table></div></div><p>声明一个全局变量。</p><h3 id=__init-和-__finit><code>__INIT</code> 和 <code>__FINIT</code><a hidden class=anchor aria-hidden=true href=#__init-和-__finit>#</a></h3><p><code>include/linux/init.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#define __INIT .section &#34;.init.text&#34;,&#34;ax&#34;
</span><span style=color:#75715e>#define __FINIT .previous
</span></code></pre></td></tr></table></div></div><p><code>.section</code> 和 <code>.previous</code> 见汇编器指令章节的相关内容。</p><h3 id=32-位和-64-位的兼容>32 位和 64 位的兼容<a hidden class=anchor aria-hidden=true href=#32-位和-64-位的兼容>#</a></h3><p>32 位和 64 位情况下的数据长度和指令不同，具体见 <code>include/asm-mips/asm.h</code>，该文件中的部分宏定义如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * Size of a register
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#ifdef __mips64
</span><span style=color:#75715e>#define SZREG 8
</span><span style=color:#75715e>#else
</span><span style=color:#75715e>#define SZREG 4
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>/*
</span><span style=color:#75715e> * How to add/sub/load/store/shift C long variables.
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#if (_MIPS_SZLONG == 32)
</span><span style=color:#75715e>#define LONG_S sw
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>#if (_MIPS_SZLONG == 64)
</span><span style=color:#75715e>#define LONG_S sd
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>/*
</span><span style=color:#75715e> * How to add/sub/load/store/shift pointers.
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#if (_MIPS_SZPTR == 32)
</span><span style=color:#75715e>#define PTR_ADDIU addiu
</span><span style=color:#75715e>#define PTR_SUBU subu
</span><span style=color:#75715e>#define PTR_LA la
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>#if (_MIPS_SZPTR == 64)
</span><span style=color:#75715e>#define PTR_ADDU daddu
</span><span style=color:#75715e>#define PTR_SUBU dsubu
</span><span style=color:#75715e>#define PTR_LA dla
</span><span style=color:#75715e>#endif
</span></code></pre></td></tr></table></div></div><h3 id=nested><code>NESTED</code><a hidden class=anchor aria-hidden=true href=#nested>#</a></h3><p><code>include/asm-mips/asm.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e>* NESTED - declare nested routine entry point
</span><span style=color:#75715e>*/</span>
<span style=color:#75715e>#define NESTED(symbol, framesize, rpc)                  \
</span><span style=color:#75715e>        .globl  symbol;                         \
</span><span style=color:#75715e>        .align  2;                              \
</span><span style=color:#75715e>        .type   symbol,@function;               \
</span><span style=color:#75715e>        .ent    symbol,0;                       \
</span><span style=color:#75715e>symbol:     .frame  sp, framesize, rpc
</span></code></pre></td></tr></table></div></div><p>定义一个函数的头部。</p><h3 id=setup_c0_status_pri><code>setup_c0_status_pri</code><a hidden class=anchor aria-hidden=true href=#setup_c0_status_pri>#</a></h3><p><code>arch/mips/kernel/head.S</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#75715e>/*
</span><span style=color:#75715e>     * For the moment disable interrupts, mark the kernel mode and
</span><span style=color:#75715e>     * set ST0_KX so that the CPU does not spit fire when using
</span><span style=color:#75715e>     * 64-bit addresses.  A full initialization of the CPU&#39;s status
</span><span style=color:#75715e>     * register is done later in per_cpu_trap_init().
</span><span style=color:#75715e>     */</span>
    .macro setup_c0_status set clr
    .set push
    mfc0 t0, CP0_STATUS <span style=color:#75715e>// t0 = $12
</span><span style=color:#75715e></span>    or t0, ST0_CU0<span style=color:#f92672>|</span><span style=color:#960050;background-color:#1e0010>\</span>set<span style=color:#f92672>|</span><span style=color:#ae81ff>0x1f</span><span style=color:#f92672>|</span><span style=color:#960050;background-color:#1e0010>\</span>clr <span style=color:#75715e>// t0 |= ST0_CU0 | set | 0x1f | clr
</span><span style=color:#75715e></span>    xor t0, <span style=color:#ae81ff>0x1f</span><span style=color:#f92672>|</span><span style=color:#960050;background-color:#1e0010>\</span>clr <span style=color:#75715e>// t0 ^= 0x1f | clr
</span><span style=color:#75715e></span>    mtc0 t0, CP0_STATUS <span style=color:#75715e>// $12 = t0
</span><span style=color:#75715e></span>    .set noreorder
    sll zero,<span style=color:#ae81ff>3</span> <span style=color:#960050;background-color:#1e0010>#</span> ehb
    .set pop
    .endm

    .macro setup_c0_status_pri
<span style=color:#75715e>#ifdef CONFIG_MIPS64
</span><span style=color:#75715e></span>    setup_c0_status ST0_KX <span style=color:#ae81ff>0</span> <span style=color:#75715e>// setup_c0_status 0x00000080 0，见宏章节的 CP0 寄存器
</span><span style=color:#75715e></span><span style=color:#75715e>#else
</span><span style=color:#75715e></span>    setup_c0_status <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e>// setup_c0_status 0 0
</span><span style=color:#75715e></span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>    .endm
</code></pre></td></tr></table></div></div><p>如果配置了 <code>CONFIG_MIPS64</code>，<code>setup_c0_status</code> 会把 CP0 的 <code>$12</code> 设置为 <code>0x80</code>；反之则设置为 <code>0</code>。具体作用注释已经给出，建议参考 <em><a href=https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MD00091-2B-MIPS64PRA-AFP-06.03.pdf>The MIPS64 and microMIPS64 Privileged Resource Architecture v6.03</a></em> 的 <code>Table 9.49</code>。</p><h3 id=cp0-寄存器>CP0 寄存器<a hidden class=anchor aria-hidden=true href=#cp0-寄存器>#</a></h3><p><code>include/asm-mips/mipsregs.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * Coprocessor 0 register names
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#define CP0_STATUS $12
</span><span style=color:#75715e></span>
<span style=color:#75715e>/*
</span><span style=color:#75715e> * Bitfields in the R4xx0 cp0 status register
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#define ST0_KX 0x00000080
</span></code></pre></td></tr></table></div></div><h3 id=get_nasid_asm><code>GET_NASID_ASM</code><a hidden class=anchor aria-hidden=true href=#get_nasid_asm>#</a></h3><p><code>arch/mips/kernel/head.S</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#ifdef CONFIG_SGI_IP27
</span><span style=color:#75715e></span>    <span style=color:#75715e>/*
</span><span style=color:#75715e>     * outputs the local nasid into res.  IP27 stuff.
</span><span style=color:#75715e>     */</span>
    .macro GET_NASID_ASM res
    dli <span style=color:#960050;background-color:#1e0010>\</span>res, LOCAL_HUB_ADDR(NI_STATUS_REV_ID)
    ld <span style=color:#960050;background-color:#1e0010>\</span>res, (<span style=color:#960050;background-color:#1e0010>\</span>res)
    and <span style=color:#960050;background-color:#1e0010>\</span>res, NSRI_NODEID_MASK
    dsrl <span style=color:#960050;background-color:#1e0010>\</span>res, NSRI_NODEID_SHFT
    .endm
<span style=color:#75715e>#endif </span><span style=color:#75715e>/* CONFIG_SGI_IP27 */</span><span style=color:#75715e>
</span></code></pre></td></tr></table></div></div><h3 id=mapped_kernel_setup_tlb><code>MAPPED_KERNEL_SETUP_TLB</code><a hidden class=anchor aria-hidden=true href=#mapped_kernel_setup_tlb>#</a></h3><p>定义于 <code>arch/mips/kernel/head.S</code>。</p><h3 id=arc64_twiddle_pc><code>ARC64_TWIDDLE_PC</code><a hidden class=anchor aria-hidden=true href=#arc64_twiddle_pc>#</a></h3><p><code>arch/mips/kernel/head.S</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    .macro ARC64_TWIDDLE_PC
<span style=color:#75715e>#if defined(CONFIG_ARC64) || defined(CONFIG_MAPPED_KERNEL)
</span><span style=color:#75715e></span>    <span style=color:#75715e>/* We get launched at a XKPHYS address but the kernel is linked to
</span><span style=color:#75715e>       run at a KSEG0 address, so jump there.  */</span>
    PTR_LA t0, <span style=color:#960050;background-color:#1e0010>\@</span>f
    jr t0
<span style=color:#960050;background-color:#1e0010>\@</span><span style=color:#f92672>:</span>
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>    .endm
</code></pre></td></tr></table></div></div><h3 id=_thread_size><code>_THREAD_SIZE</code><a hidden class=anchor aria-hidden=true href=#_thread_size>#</a></h3><p>定义于 <code>arch/mips/kernel/offset.c</code> ，该文件会根据 <code>arch/mips/Makefile</code> 中的规则，生成 <code>asm/offset.h</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=color:#75715e># Generate &lt;asm/offset.h&gt;
</span><span style=color:#75715e>#
</span><span style=color:#75715e># The default rule is suffering from funny problems on MIPS so we using our
</span><span style=color:#75715e># own ...
</span><span style=color:#75715e>#
</span><span style=color:#75715e># ---------------------------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#960050;background-color:#1e0010>define</span> <span style=color:#960050;background-color:#1e0010>filechk_gen-asm-offset.h</span>
    <span style=color:#960050;background-color:#1e0010>(set</span> <span style=color:#960050;background-color:#1e0010>-e;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34;#ifndef _ASM_OFFSET_H&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34;#define _ASM_OFFSET_H&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34;/*&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34; * DO NOT MODIFY.&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34; *&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34; * This file was generated by arch/$(ARCH)/Makefile&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34; *&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34; */&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>sed</span> <span style=color:#960050;background-color:#1e0010>-ne</span> <span style=color:#e6db74>&#34;/^@@@/s///p&#34;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
     <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#34;#endif /* _ASM_OFFSET_H */&#34;</span> <span style=color:#960050;background-color:#1e0010>)</span>
<span style=color:#960050;background-color:#1e0010>endef</span>

<span style=color:#a6e22e>prepare</span><span style=color:#f92672>:</span> include/asm-<span style=color:#66d9ef>$(</span>ARCH<span style=color:#66d9ef>)</span>/offset.h

<span style=color:#a6e22e>arch/$(ARCH)/kernel/offset.s</span><span style=color:#f92672>:</span> include/asm include/linux/version.h \
                   include/config/MARKER

<span style=color:#a6e22e>include/asm-$(ARCH)/offset.h</span><span style=color:#f92672>:</span> arch/<span style=color:#66d9ef>$(</span>ARCH<span style=color:#66d9ef>)</span>/kernel/offset.s
    <span style=color:#66d9ef>$(</span>call filechk,gen-asm-offset.h<span style=color:#66d9ef>)</span>
</code></pre></td></tr></table></div></div><p><code>Makefile</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=color:#75715e># filechk is used to check if the content of a generated file is updated.
</span><span style=color:#75715e># Sample usage:
</span><span style=color:#75715e># define filechk_sample
</span><span style=color:#75715e>#   echo $KERNELRELEASE
</span><span style=color:#75715e># endef
</span><span style=color:#75715e># version.h : Makefile
</span><span style=color:#75715e>#   $(call filechk,sample)
</span><span style=color:#75715e># The rule defined shall write to stdout the content of the new file.
</span><span style=color:#75715e># The existing file will be compared with the new one.
</span><span style=color:#75715e># - If no file exist it is created
</span><span style=color:#75715e># - If the content differ the new file is used
</span><span style=color:#75715e># - If they are equal no change, and no timestamp update
</span><span style=color:#75715e></span>
<span style=color:#960050;background-color:#1e0010>define</span> <span style=color:#960050;background-color:#1e0010>filechk</span>
    <span style=color:#960050;background-color:#1e0010>@set</span> <span style=color:#960050;background-color:#1e0010>-e;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#39;  CHK     $@&#39;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#960050;background-color:#1e0010>mkdir</span> <span style=color:#960050;background-color:#1e0010>-p</span> <span style=color:#66d9ef>$(</span>dir <span style=color:#66d9ef>$</span>@<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#66d9ef>$(</span>filechk_<span style=color:#66d9ef>$(</span>1<span style=color:#66d9ef>))</span> <span style=color:#960050;background-color:#1e0010>&lt;</span> <span style=color:#66d9ef>$&lt;</span> <span style=color:#960050;background-color:#1e0010>&gt;</span> <span style=color:#66d9ef>$@</span><span style=color:#960050;background-color:#1e0010>.tmp;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>[</span> <span style=color:#960050;background-color:#1e0010>-r</span> <span style=color:#66d9ef>$@</span> <span style=color:#960050;background-color:#1e0010>]</span> <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>cmp</span> <span style=color:#960050;background-color:#1e0010>-s</span> <span style=color:#66d9ef>$@</span> <span style=color:#66d9ef>$@</span><span style=color:#960050;background-color:#1e0010>.tmp;</span> <span style=color:#960050;background-color:#1e0010>then</span> <span style=color:#960050;background-color:#1e0010>\</span>
        <span style=color:#960050;background-color:#1e0010>rm</span> <span style=color:#960050;background-color:#1e0010>-f</span> <span style=color:#66d9ef>$@</span><span style=color:#960050;background-color:#1e0010>.tmp;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#960050;background-color:#1e0010>else</span> <span style=color:#960050;background-color:#1e0010>\</span>
        <span style=color:#960050;background-color:#1e0010>echo</span> <span style=color:#e6db74>&#39;  UPD     $@&#39;</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
        <span style=color:#960050;background-color:#1e0010>mv</span> <span style=color:#960050;background-color:#1e0010>-f</span> <span style=color:#66d9ef>$@</span><span style=color:#960050;background-color:#1e0010>.tmp</span> <span style=color:#66d9ef>$@</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#960050;background-color:#1e0010>\</span>
    <span style=color:#960050;background-color:#1e0010>fi</span>
<span style=color:#960050;background-color:#1e0010>endef</span>
</code></pre></td></tr></table></div></div><p>查看文件中 <code>_THREAD_SIZE</code> 相关代码，最终该宏相当于 <code>#define _THREAD_SIZE THREAD_SIZE</code>。</p><h3 id=thread_size><code>THREAD_SIZE</code><a hidden class=anchor aria-hidden=true href=#thread_size>#</a></h3><p><code>include/asm-mips/thread_info.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/* thread information allocation */</span>
<span style=color:#75715e>#if defined(CONFIG_PAGE_SIZE_4KB) &amp;&amp; defined(CONFIG_MIPS32)
</span><span style=color:#75715e>#define THREAD_SIZE_ORDER (1)
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#if defined(CONFIG_PAGE_SIZE_4KB) &amp;&amp; defined(CONFIG_MIPS64)
</span><span style=color:#75715e>#define THREAD_SIZE_ORDER (2)
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_8KB
</span><span style=color:#75715e>#define THREAD_SIZE_ORDER (1)
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_16KB
</span><span style=color:#75715e>#define THREAD_SIZE_ORDER (0)
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_64KB
</span><span style=color:#75715e>#define THREAD_SIZE_ORDER (0)
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define THREAD_SIZE (PAGE_SIZE &lt;&lt; THREAD_SIZE_ORDER)
</span></code></pre></td></tr></table></div></div><p>include/asm-mips/page.h：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * PAGE_SHIFT determines the page size
</span><span style=color:#75715e> */</span>
<span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_4KB
</span><span style=color:#75715e>#define PAGE_SHIFT 12
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_8KB
</span><span style=color:#75715e>#define PAGE_SHIFT 13
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_16KB
</span><span style=color:#75715e>#define PAGE_SHIFT 14
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#ifdef CONFIG_PAGE_SIZE_64KB
</span><span style=color:#75715e>#define PAGE_SHIFT 16
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e>#define PAGE_SIZE (1UL &lt;&lt; PAGE_SHIFT)
</span></code></pre></td></tr></table></div></div><h3 id=set_saved_sp><code>set_saved_sp</code><a hidden class=anchor aria-hidden=true href=#set_saved_sp>#</a></h3><p>定义于 <code>include/asm-mips/stackframe.h</code>，见后续笔记。</p><h3 id=end><code>END</code><a hidden class=anchor aria-hidden=true href=#end>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e>* END - mark end of function
</span><span style=color:#75715e>*/</span>
<span style=color:#75715e>#define END(function)                                   \
</span><span style=color:#75715e>        .end    function;               \
</span><span style=color:#75715e>        .size   function,.-function
</span></code></pre></td></tr></table></div></div><p>定义一个函数的尾部。</p><h3 id=cp0_status><code>CP0_STATUS</code><a hidden class=anchor aria-hidden=true href=#cp0_status>#</a></h3><p><code>include/asm-mips/mipsregs.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#define CP0_STATUS $12
</span></code></pre></td></tr></table></div></div><h3 id=config_sgi_ip27><code>CONFIG_SGI_IP27</code><a hidden class=anchor aria-hidden=true href=#config_sgi_ip27>#</a></h3><p>arch/mips/Makefile:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=color:#75715e>#
</span><span style=color:#75715e># SGI-IP27 (Origin200/2000)
</span><span style=color:#75715e>#
</span><span style=color:#75715e># Set the load address to &gt;= 0xc000000000300000 if you want to leave space for
</span><span style=color:#75715e># symmon, 0xc00000000001c000 for production kernels.  Note that the value must
</span><span style=color:#75715e># be 16kb aligned or the handling of the current variable will break.
</span><span style=color:#75715e>#
</span></code></pre></td></tr></table></div></div><h3 id=asmlinkage><code>asmlinkage</code><a hidden class=anchor aria-hidden=true href=#asmlinkage>#</a></h3><p><code>include/linux/linkage.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;asm/linkage.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#ifdef __cplusplus
</span><span style=color:#75715e>#define CPP_ASMLINKAGE extern &#34;C&#34;
</span><span style=color:#75715e>#else
</span><span style=color:#75715e>#define CPP_ASMLINKAGE
</span><span style=color:#75715e>#endif
</span><span style=color:#75715e></span>
<span style=color:#75715e>#ifndef asmlinkage
</span><span style=color:#75715e>#define asmlinkage CPP_ASMLINKAGE
</span><span style=color:#75715e>#endif
</span></code></pre></td></tr></table></div></div><p><code>include/asm-mips/linkage.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/* Nothing to see here... */</span>
</code></pre></td></tr></table></div></div><p>在 MIPS 下，<code>asmlinkage</code> 只是为了兼容 <code>C++</code>。</p><h3 id=__init><code>__init</code><a hidden class=anchor aria-hidden=true href=#__init>#</a></h3><p><code>include/linux/init.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#define __init __attribute__ ((__section__ (&#34;.init.text&#34;)))
</span></code></pre></td></tr></table></div></div><p>把函数放到 <code>.init.text</code> 段。</p><h3 id=__acquires-和-__releases><code>__acquires</code> 和 <code>__releases</code><a hidden class=anchor aria-hidden=true href=#__acquires-和-__releases>#</a></h3><p><code>include/linux/compiler.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e># define __acquires(x) __attribute__((context(0,1)))
</span><span style=color:#75715e># define __releases(x) __attribute__((context(1,0)))
</span></code></pre></td></tr></table></div></div><p>给 Sparse 做代码静态检查，用于保证 <code>__acquires</code> 和 <code>__releases</code> 成对使用。Sparse 的相关内容可以参考 <em><a href=https://www.kernel.org/doc/html/latest/dev-tools/sparse.html>The Linux Kernel documentation</a></em>。</p><h3 id=__lockfunc><code>__lockfunc</code><a hidden class=anchor aria-hidden=true href=#__lockfunc>#</a></h3><p><code>include/linux/spinlock.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#define __lockfunc fastcall __attribute__((section(&#34;.spinlock.text&#34;)))
</span></code></pre></td></tr></table></div></div><p><code>include/linux/linkage.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#ifndef FASTCALL
</span><span style=color:#75715e>#define FASTCALL(x) x
</span><span style=color:#75715e>#define fastcall
</span><span style=color:#75715e>#endif
</span></code></pre></td></tr></table></div></div><p><code>include/asm-mips/linkage.h</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/* Nothing to see here... */</span>
</code></pre></td></tr></table></div></div><p>在 MIPS 下，<code>fastcall</code> 为空，<code>__lockfunc</code> 只是为了把函数放到 <code>.spinlock.text</code> 段。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://freeflyingsheep.github.io/tags/linux-%E5%86%85%E6%A0%B8/>Linux 内核</a></li><li><a href=https://freeflyingsheep.github.io/tags/mips/>MIPS</a></li></ul><nav class=paginav><a class=prev href=https://freeflyingsheep.github.io/posts/kernel/memory/buddy-system/><span class=title>«</span><br><span>伙伴系统</span></a>
<a class=next href=https://freeflyingsheep.github.io/posts/git/command/><span class=title>»</span><br><span>Git 常用命令</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://freeflyingsheep.github.io/>FreeFlyingSheep 的小站</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>